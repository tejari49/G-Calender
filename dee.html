<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feinplanung - Industrielle Schichtplanung</title>
    <!-- FEATURES: Vollständige Feinplanung mit D&D, CRUD für Schichten/Arbeitsbereiche, CSV-Import, Kapazitätsberechnung, Offline-Persistenz -->
    <!-- SHORTCUTS: ESC schließt Dialoge, Ctrl+S speichert im Editor, Ctrl+F sucht im Backlog -->
    <!-- LIMITATIONS: Keine Mehrbenutzer-Synchronisation, Keine Server-API, Keine Druckfunktion -->
    <!-- RESET: Admin-PIN "1234" in Settings, Daten-Reset mit Bestätigung -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --light: #f8fafc;
            --dark: #1e293b;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --border-radius: 6px;
            --shadow: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
            --transition: all 0.2s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background: var(--gray-100);
            color: var(--dark);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Topbar */
        .topbar {
            background: white;
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow);
            z-index: 100;
            flex-shrink: 0;
        }

        .topbar-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .logo i {
            font-size: 1.75rem;
        }

        .view-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--border-radius);
            background: var(--gray-200);
            color: var(--gray-700);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            transition: var(--transition);
        }

        .btn:hover {
            background: var(--gray-300);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #0da271;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }

        .btn-icon {
            padding: 0.5rem;
            width: 2.25rem;
            height: 2.25rem;
            justify-content: center;
        }

        .date-navigator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--gray-100);
            padding: 0.5rem;
            border-radius: var(--border-radius);
        }

        .current-date {
            font-weight: 600;
            min-width: 180px;
            text-align: center;
        }

        .role-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            background: var(--gray-200);
        }

        .role-admin {
            background: var(--primary);
            color: white;
        }

        .role-user {
            background: var(--gray-500);
            color: white;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .sidebar.collapsed {
            width: 0;
            border-right: none;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .section {
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-600);
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .filter-list {
            list-style: none;
        }

        .filter-item {
            padding: 0.5rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
            transition: var(--transition);
        }

        .filter-item:hover {
            background: var(--gray-100);
        }

        .filter-item.active {
            background: var(--primary);
            color: white;
        }

        .workarea-list {
            list-style: none;
        }

        .workarea-item {
            padding: 0.75rem;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--gray-400);
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            transition: var(--transition);
        }

        .workarea-item.active {
            background: white;
            border-color: var(--primary);
            font-weight: 600;
        }

        .workarea-item.inactive {
            background: var(--gray-100);
            color: var(--gray-500);
            border-color: var(--gray-300);
        }

        .workarea-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
        }

        .capacity-bar {
            height: 4px;
            background: var(--gray-200);
            border-radius: 2px;
            margin-top: 0.25rem;
            overflow: hidden;
        }

        .capacity-fill {
            height: 100%;
            background: var(--success);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .capacity-fill.warning {
            background: var(--warning);
        }

        .capacity-fill.danger {
            background: var(--danger);
        }

        /* Planning Board */
        .planning-board {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: white;
        }

        .board-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .view-tabs {
            display: flex;
            gap: 0.5rem;
        }

        .view-tab {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: var(--border-radius);
            font-weight: 500;
            transition: var(--transition);
        }

        .view-tab.active {
            background: var(--primary);
            color: white;
        }

        .board-content {
            flex: 1;
            overflow: auto;
            position: relative;
        }

        /* Week View */
        .week-view {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-width: 1200px;
        }

        .week-header {
            display: flex;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .resource-header {
            width: 200px;
            padding: 0.75rem;
            border-right: 1px solid var(--gray-200);
            font-weight: 600;
            background: white;
            flex-shrink: 0;
        }

        .days-header {
            display: flex;
            flex: 1;
        }

        .day-column {
            flex: 1;
            min-width: 150px;
            border-right: 1px solid var(--gray-200);
            padding: 0.5rem;
            text-align: center;
        }

        .day-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .day-date {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .day-today {
            background: var(--primary);
            color: white;
            border-radius: var(--border-radius);
            padding: 0.25rem 0.5rem;
        }

        .week-body {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .resource-row {
            display: flex;
            border-bottom: 1px solid var(--gray-200);
            min-height: 80px;
        }

        .resource-cell {
            width: 200px;
            padding: 0.75rem;
            border-right: 1px solid var(--gray-200);
            flex-shrink: 0;
            background: white;
        }

        .resource-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .resource-shifts {
            font-size: 0.75rem;
            color: var(--gray-600);
        }

        .time-slots {
            flex: 1;
            display: flex;
            position: relative;
        }

        .day-slot {
            flex: 1;
            border-right: 1px solid var(--gray-200);
            position: relative;
        }

        .time-marker {
            position: absolute;
            height: 1px;
            background: var(--gray-200);
            width: 100%;
            font-size: 0.75rem;
            color: var(--gray-500);
            pointer-events: none;
            z-index: 0;
        }

        .time-marker::before {
            content: attr(data-time);
            position: absolute;
            left: 4px;
            top: -10px;
            background: white;
            padding: 0 4px;
            pointer-events: none;
        }
        
        /* Hide time markers when jobs are present to improve readability */
        .day-slot:has(.job-card) .time-marker::before {
            display: none;
        }
        /* Job Cards */
        .job-card {
            position: absolute;
            border-radius: var(--border-radius);
            padding: 0.5rem;
            font-size: 0.875rem;
            overflow: hidden;
            cursor: move;
            border-left: 4px solid var(--gray-400);
            box-shadow: var(--shadow);
            transition: var(--transition);
            min-height: 40px;
            user-select: none;
        }

        .job-card:hover {
            box-shadow: var(--shadow-lg);
            z-index: 5;
        }

        .job-card.geplant { border-color: var(--info); background: #dbeafe; }
        .job-card.freigegeben { border-color: var(--success); background: #d1fae5; }
        .job-card.inArbeit { border-color: var(--primary); background: #dbeafe; }
        .job-card.fertig { border-color: var(--success); background: #d1fae5; opacity: 0.8; }
        .job-card.blockiert { border-color: var(--danger); background: #fee2e2; }
        .job-card.störung { border-color: #f97316; background: #ffedd5; }

        .job-title {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .job-time {
            font-size: 0.75rem;
            color: var(--gray-600);
            margin-top: 0.125rem;
        }

        .job-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.625rem;
            padding: 0.125rem 0.25rem;
            border-radius: 2px;
            background: var(--danger);
            color: white;
        }

        /* Backlog */
        .backlog {
            width: 320px;
            background: white;
            border-left: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .backlog.collapsed {
            width: 0;
            border-left: none;
        }

        .backlog-header {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .backlog-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .search-box {
            position: relative;
            margin-bottom: 1rem;
        }

        .search-input {
            width: 100%;
            padding: 0.5rem 2.5rem 0.5rem 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 0.875rem;
        }

        .search-icon {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
        }

        .backlog-list {
            list-style: none;
        }

        .backlog-item {
            padding: 0.75rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-200);
            margin-bottom: 0.75rem;
            cursor: move;
            transition: var(--transition);
        }

        .backlog-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .backlog-priority {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            text-align: center;
            line-height: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 0.5rem;
        }

        .priority-1 { background: var(--danger); color: white; }
        .priority-2 { background: #f97316; color: white; }
        .priority-3 { background: var(--warning); color: white; }
        .priority-4 { background: var(--info); color: white; }
        .priority-5 { background: var(--success); color: white; }

        .load-more {
            text-align: center;
            margin-top: 1rem;
        }

        /* Modals & Drawers */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: transparent;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-500);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: var(--gray-100);
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .drawer {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 500px;
            background: white;
            box-shadow: var(--shadow-lg);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1001;
            display: flex;
            flex-direction: column;
        }

        .drawer.active {
            transform: translateX(0);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.375rem;
            font-weight: 500;
            color: var(--gray-700);
        }

        .form-control {
            width: 100%;
            padding: 0.625rem 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-control:disabled {
            background: var(--gray-100);
            cursor: not-allowed;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.25rem;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .form-check {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .form-check-input {
            width: 18px;
            height: 18px;
        }

        .form-check-label {
            font-size: 0.875rem;
        }

        .color-picker {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .color-option {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: var(--transition);
        }

        .color-option.selected {
            border-color: var(--dark);
            transform: scale(1.1);
        }

        .validation-error {
            color: var(--danger);
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }

        .validation-error.show {
            display: block;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .toast {
            background: white;
            border-radius: var(--border-radius);
            padding: 1rem 1.25rem;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 350px;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast-success {
            border-left: 4px solid var(--success);
        }

        .toast-error {
            border-left: 4px solid var(--danger);
        }

        .toast-warning {
            border-left: 4px solid var(--warning);
        }

        .toast-info {
            border-left: 4px solid var(--info);
        }

        .toast-icon {
            font-size: 1.25rem;
        }

        .toast-success .toast-icon { color: var(--success); }
        .toast-error .toast-icon { color: var(--danger); }
        .toast-warning .toast-icon { color: var(--warning); }
        .toast-info .toast-icon { color: var(--info); }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 10;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 500;
            color: var(--gray-600);
            border-bottom: 2px solid transparent;
            transition: var(--transition);
            position: relative;
            z-index: 11;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
            position: relative;
            z-index: 1;
        }

        .tab-content.active {
            display: block;
        }

        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .data-table th {
            text-align: left;
            padding: 0.75rem;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            font-weight: 600;
            color: var(--gray-700);
        }

        .data-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--gray-200);
            vertical-align: top;
        }

        .data-table tr:hover {
            background: var(--gray-50);
        }

        .table-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        /* Drag & Drop */
        .dragging {
            opacity: 0.7;
            transform: rotate(3deg);
        }

        .drop-target {
            background: var(--gray-100);
            border: 2px dashed var(--primary);
        }

        /* Mobile */
        .mobile-toggle {
            display: none;
            background: transparent;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            color: var(--gray-600);
        }

        @media (max-width: 1200px) {
            .mobile-toggle {
                display: block;
            }
            
            .sidebar:not(.collapsed) {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                z-index: 1000;
                box-shadow: var(--shadow-lg);
            }
            
            .backlog:not(.collapsed) {
                position: fixed;
                right: 0;
                top: 0;
                bottom: 0;
                z-index: 1000;
                box-shadow: var(--shadow-lg);
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--gray-100);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray-400);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gray-500);
        }
    </style>
</head>
<body>
    <!-- Topbar -->
    <div class="topbar">
        <div class="topbar-left">
            <button class="btn btn-icon mobile-toggle" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="logo">
                <i class="fas fa-industry"></i>
                <span>Feinplanung</span>
            </div>
            <div class="view-controls">
                <button class="btn btn-sm" id="todayBtn">
                    <i class="fas fa-calendar-day"></i> Heute
                </button>
                <div class="date-navigator">
                    <button class="btn btn-icon btn-sm" id="prevBtn">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="current-date" id="currentDate">Montag, 01. Januar 2024</div>
                    <button class="btn btn-icon btn-sm" id="nextBtn">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <select class="form-control" id="viewSelect" style="width: auto; padding: 0.375rem 0.75rem;">
                    <option value="week">Woche</option>
                    <option value="day">Tag</option>
                    <option value="list">Liste</option>
                </select>
            </div>
        </div>
        <div class="topbar-right">
            <button class="btn btn-sm" id="exportBtn">
                <i class="fas fa-download"></i> Export
            </button>
            <button class="btn btn-sm" id="importBtn">
                <i class="fas fa-upload"></i> Import
            </button>
            <button class="btn btn-sm" id="settingsBtn">
                <i class="fas fa-cog"></i> Settings
            </button>
            <div class="role-badge role-admin" id="roleBadge">ADMIN</div>
            <button class="btn btn-icon" id="roleToggle">
                <i class="fas fa-user-shield"></i>
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span>Arbeitsbereiche & Filter</span>
                <button class="btn btn-icon btn-sm" id="addWorkAreaBtn">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div class="sidebar-content">
                <div class="section">
                    <div class="section-title">Arbeitsbereiche</div>
                    <ul class="workarea-list" id="workareaList">
                        <!-- Dynamically populated -->
                    </ul>
                </div>
                <div class="section">
                    <div class="section-title">Status Filter</div>
                    <ul class="filter-list" id="statusFilter">
                        <li class="filter-item active" data-status="all">
                            <i class="fas fa-circle"></i> Alle
                        </li>
                        <li class="filter-item" data-status="geplant">
                            <i class="fas fa-circle" style="color: #3b82f6;"></i> Geplant
                        </li>
                        <li class="filter-item" data-status="freigegeben">
                            <i class="fas fa-circle" style="color: #10b981;"></i> Freigegeben
                        </li>
                        <li class="filter-item" data-status="inArbeit">
                            <i class="fas fa-circle" style="color: #2563eb;"></i> In Arbeit
                        </li>
                        <li class="filter-item" data-status="fertig">
                            <i class="fas fa-circle" style="color: #10b981;"></i> Fertig
                        </li>
                        <li class="filter-item" data-status="blockiert">
                            <i class="fas fa-circle" style="color: #ef4444;"></i> Blockiert
                        </li>
                        <li class="filter-item" data-status="störung">
                            <i class="fas fa-circle" style="color: #f97316;"></i> Störung
                        </li>
                    </ul>
                </div>
                <div class="section">
                    <div class="section-title">Schnellaktionen</div>
                    <button class="btn btn-sm" id="quickAddJob" style="width: 100%; margin-bottom: 0.5rem;">
                        <i class="fas fa-plus"></i> Neuer Auftrag
                    </button>
                    <button class="btn btn-sm" id="manageShiftsBtn" style="width: 100%;">
                        <i class="fas fa-clock"></i> Schichten verwalten
                    </button>
                </div>
            </div>
        </div>

        <!-- Planning Board -->
        <div class="planning-board">
            <div class="board-header">
                <div class="view-tabs">
                    <button class="view-tab active" data-view="week">Woche</button>
                    <button class="view-tab" data-view="day">Tag</button>
                    <button class="view-tab" data-view="list">Liste</button>
                </div>
                <div>
                    <button class="btn btn-sm" id="collapseBacklogBtn">
                        <i class="fas fa-chevron-right"></i> Backlog
                    </button>
                </div>
            </div>
            <div class="board-content" id="boardContent">
                <!-- Week View -->
                <div class="week-view" id="weekView">
                    <div class="week-header">
                        <div class="resource-header">Arbeitsbereich</div>
                        <div class="days-header" id="daysHeader">
                            <!-- Dynamically populated -->
                        </div>
                    </div>
                    <div class="week-body" id="weekBody">
                        <!-- Dynamically populated -->
                    </div>
                </div>
                
                <!-- Day View (hidden by default) -->
                <div class="day-view" id="dayView" style="display: none;">
                    <div style="padding: 1rem; text-align: center;">
                        <h3>Tagesansicht in Entwicklung</h3>
                        <p>Detailierte Tagesansicht mit Stundenraster</p>
                    </div>
                </div>
                
                <!-- List View (hidden by default) -->
                <div class="list-view" id="listView" style="display: none;">
                    <div style="padding: 1rem;">
                        <h3>Listenansicht</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Auftrag</th>
                                    <th>Arbeitsbereich</th>
                                    <th>Start</th>
                                    <th>Ende</th>
                                    <th>Status</th>
                                    <th>Priorität</th>
                                </tr>
                            </thead>
                            <tbody id="listViewBody">
                                <!-- Dynamically populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Backlog -->
        <div class="backlog" id="backlog">
            <div class="backlog-header">
                <span>Backlog</span>
                <div>
                    <button class="btn btn-icon btn-sm" id="backlogSearchToggle">
                        <i class="fas fa-search"></i>
                    </button>
                    <button class="btn btn-icon btn-sm" id="addBacklogJobBtn">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            <div class="backlog-content">
                <div class="search-box" id="backlogSearch" style="display: none;">
                    <input type="text" class="search-input" id="backlogSearchInput" placeholder="Suche nach Artikel oder Bezeichnung...">
                    <i class="fas fa-search search-icon"></i>
                </div>
                <ul class="backlog-list" id="backlogList">
                    <!-- Dynamically populated -->
                </ul>
                <div class="load-more">
                    <button class="btn btn-sm" id="loadMoreBacklog">
                        <i class="fas fa-chevron-down"></i> Mehr laden (30)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Job Editor Modal -->
    <div class="modal-overlay" id="jobEditorModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Auftrag bearbeiten</div>
                <button class="modal-close" id="closeJobEditor">&times;</button>
            </div>
            <div class="modal-body">
                <form id="jobForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Artikelnummer *</label>
                            <input type="text" class="form-control" id="artikelNr" list="productList" required>
                            <datalist id="productList"></datalist>
                            <div class="validation-error" id="artikelNrError">Artikelnummer ist erforderlich</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Bezeichnung *</label>
                            <input type="text" class="form-control" id="bezeichnung" required>
                            <div class="validation-error" id="bezeichnungError">Bezeichnung ist erforderlich</div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Menge/Batch *</label>
                            <input type="number" class="form-control" id="menge" min="1" step="1" value="1" required>
                            <div class="validation-error" id="mengeError">Menge muss größer als 0 sein</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Priorität *</label>
                            <select class="form-control" id="priorität" required>
                                <option value="1">1 - Höchste</option>
                                <option value="2">2 - Hoch</option>
                                <option value="3">3 - Mittel</option>
                                <option value="4">4 - Niedrig</option>
                                <option value="5" selected>5 - Niedrigste</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Arbeitsbereich</label>
                            <select class="form-control" id="workAreaId">
                                <option value="">-- Backlog (ungeplant) --</option>
                                <!-- Dynamically populated -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Schicht</label>
                            <select class="form-control" id="shiftTemplateId">
                                <option value="">-- Automatisch --</option>
                                <!-- Dynamically populated -->
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Start *</label>
                            <input type="datetime-local" class="form-control" id="start" required>
                            <div class="validation-error" id="startError">Start muss vor Ende liegen</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ende *</label>
                            <input type="datetime-local" class="form-control" id="end" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Setup (Minuten)</label>
                            <input type="number" class="form-control" id="setupMin" min="0" step="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Laufzeit (Minuten)</label>
                            <input type="number" class="form-control" id="laufzeitMin" min="1" step="1">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-control" id="status">
                                <option value="geplant">Geplant</option>
                                <option value="freigegeben">Freigegeben</option>
                                <option value="inArbeit">In Arbeit</option>
                                <option value="fertig">Fertig</option>
                                <option value="blockiert">Blockiert</option>
                                <option value="störung">Störung</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Farbe</label>
                            <div class="color-picker" id="colorPicker">
                                <div class="color-option" style="background: #3b82f6;" data-color="#3b82f6"></div>
                                <div class="color-option" style="background: #10b981;" data-color="#10b981"></div>
                                <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b"></div>
                                <div class="color-option" style="background: #ef4444;" data-color="#ef4444"></div>
                                <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6"></div>
                                <div class="color-option" style="background: #ec4899;" data-color="#ec4899"></div>
                                <div class="color-option" style="background: #6366f1;" data-color="#6366f1"></div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notiz</label>
                        <textarea class="form-control" id="notiz" rows="3"></textarea>
                    </div>
                    <div class="form-group" id="conflictWarning" style="display: none;">
                        <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 0.75rem;">
                            <strong><i class="fas fa-exclamation-triangle"></i> Warnung:</strong>
                            <span id="conflictText">Überlappung mit anderen Aufträgen oder außerhalb der Schicht!</span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelJobEditor">Abbrechen</button>
                <button class="btn btn-danger" id="deleteJobBtn" style="display: none;">Löschen</button>
                <button class="btn" id="duplicateJobBtn" style="display: none;">Duplizieren</button>
                <button class="btn btn-primary" id="saveJobBtn">Speichern</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title">Einstellungen & Administration</div>
                <button class="modal-close" id="closeSettings">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <button class="tab active" data-tab="workareas">Arbeitsbereiche</button>
                    <button class="tab" data-tab="shifts">Schichten</button>
                    <button class="tab" data-tab="products">Produktstamm</button>
                    <button class="tab" data-tab="import">Import</button>
                    <button class="tab" data-tab="data">Datenmanagement</button>
                </div>
                
                <!-- WorkAreas Tab -->
                <div class="tab-content active" id="tab-workareas">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4>Arbeitsbereiche verwalten</h4>
                        <button class="btn btn-sm" id="addWorkAreaModalBtn">
                            <i class="fas fa-plus"></i> Neu
                        </button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Schichten</th>
                                <th>Kapazität</th>
                                <th>Status</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="workareasTableBody">
                            <!-- Dynamically populated -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Shifts Tab -->
                <div class="tab-content" id="tab-shifts">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4>Schichtvorlagen verwalten</h4>
                        <button class="btn btn-sm" id="addShiftTemplateBtn">
                            <i class="fas fa-plus"></i> Neu
                        </button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Zeitfenster</th>
                                <th>Pause (min)</th>
                                <th>Farbe</th>
                                <th>Status</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="shiftsTableBody">
                            <!-- Dynamically populated -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Products Tab -->
                <div class="tab-content" id="tab-products">
                    <h4>Produktstamm (KPI)</h4>
                    <p style="margin-bottom: 1rem; font-size: 0.875rem;">
                        Importieren Sie Produktstammdaten per CSV mit folgenden Spalten:<br>
                        <code>artikelNr;bezeichnung;arbeitsbereichDefault;laufzeitMin;setupMin;bemerkung</code>
                    </p>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">CSV Datei auswählen</label>
                            <input type="file" class="form-control" id="productCsvFile" accept=".csv">
                        </div>
                        <div class="form-group" style="align-self: flex-end;">
                            <button class="btn btn-primary" id="importProductsBtn">Importieren</button>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem;">
                        <h5>Vorhandene Produkte (<span id="productCount">0</span>)</h5>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ArtikelNr</th>
                                        <th>Bezeichnung</th>
                                        <th>Laufzeit</th>
                                        <th>Setup</th>
                                        <th>Standard-Bereich</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTableBody">
                                    <!-- Dynamically populated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Import Tab -->
                <div class="tab-content" id="tab-import">
                    <h4>Backlog-Import</h4>
                    <p style="margin-bottom: 1rem; font-size: 0.875rem;">
                        Importieren Sie Aufträge per CSV mit folgenden Spalten:<br>
                        <code>id;artikelNr;bezeichnung;menge;priorität;wunschtermin</code> (optional)
                    </p>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">CSV Datei auswählen</label>
                            <input type="file" class="form-control" id="backlogCsvFile" accept=".csv">
                        </div>
                        <div class="form-group" style="align-self: flex-end;">
                            <button class="btn btn-primary" id="importBacklogBtn">Importieren</button>
                        </div>
                    </div>
                </div>
                
                <!-- Data Management Tab -->
                <div class="tab-content" id="tab-data">
                    <h4>Datenmanagement</h4>
                    <div class="form-group">
                        <label class="form-label">JSON-Daten exportieren</label>
                        <button class="btn btn-primary" id="exportJsonBtn" style="width: 100%;">
                            <i class="fas fa-download"></i> Vollständigen Datensatz exportieren
                        </button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">JSON-Daten importieren</label>
                        <div class="form-row">
                            <div class="form-group">
                                <input type="file" class="form-control" id="importJsonFile" accept=".json">
                            </div>
                            <div class="form-group">
                                <select class="form-control" id="importStrategy">
                                    <option value="merge">Merge (bestehende Daten beibehalten)</option>
                                    <option value="overwrite">Überschreiben (alle Daten ersetzen)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button class="btn btn-primary" id="importJsonBtn">Importieren</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Admin-PIN</label>
                        <div class="form-row">
                            <div class="form-group">
                                <input type="password" class="form-control" id="adminPin" value="1234" placeholder="Admin PIN">
                            </div>
                            <div class="form-group">
                                <button class="btn btn-danger" id="resetDataBtn">
                                    <i class="fas fa-trash"></i> Feinplanungsdaten zurücksetzen
                                </button>
                            </div>
                        </div>
                        <p style="font-size: 0.875rem; color: var(--gray-600);">
                            Warnung: Setzt alle Aufträge und Planungen zurück, behält Stammdaten bei.
                        </p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="closeSettingsBtn">Schließen</button>
            </div>
        </div>
    </div>

    <!-- WorkArea Editor Drawer -->
    <div class="drawer" id="workAreaDrawer">
        <div class="modal-header">
            <div class="modal-title" id="workAreaDrawerTitle">Neuer Arbeitsbereich</div>
            <button class="modal-close" id="closeWorkAreaDrawer">&times;</button>
        </div>
        <div class="modal-body">
            <form id="workAreaForm">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" class="form-control" id="workAreaName" required>
                    <div class="validation-error" id="workAreaNameError">Name ist erforderlich</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Beschreibung (optional)</label>
                    <textarea class="form-control" id="workAreaDescription" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Kapazitäts-Multiplikator</label>
                    <input type="number" class="form-control" id="workAreaMultiplier" min="0.1" step="0.1" value="1.0">
                    <div style="font-size: 0.875rem; color: var(--gray-600);">
                        1.0 = Normalkapazität, 1.5 = 150% Kapazität, etc.
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Schichtvorlagen *</label>
                    <div id="shiftTemplatesCheckboxes">
                        <!-- Dynamically populated -->
                    </div><!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
                    <div class="current-date" id="currentDate">Montag, 01. Januar 2024</div>
                    <button class="btn btn-icon btn-sm" id="nextBtn">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <select class="form-control" id="viewSelect" style="width: auto; padding: 0.375rem 0.75rem;">
                    <option value="week">Woche</option>
                    <option value="day">Tag</option>
                    <option value="list">Liste</option>
                </select>
            </div>
        </div>
        <div class="topbar-right">
            <button class="btn btn-sm" id="exportBtn">
                <i class="fas fa-download"></i> Export
            </button>
            <button class="btn btn-sm" id="importBtn">
                <i class="fas fa-upload"></i> Import
            </button>
            <button class="btn btn-sm" id="settingsBtn">
                <i class="fas fa-cog"></i> Settings
            </button>
            <div class="role-badge role-admin" id="roleBadge">ADMIN</div>
            <button class="btn btn-icon" id="roleToggle">
                <i class="fas fa-user-shield"></i>
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span>Arbeitsbereiche & Filter</span>
                <button class="btn btn-icon btn-sm" id="addWorkAreaBtn">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div class="sidebar-content">
                <div class="section">
                    <div class="section-title">Arbeitsbereiche</div>
                    <ul class="workarea-list" id="workareaList">
                        <!-- Dynamically populated -->
                    </ul>
                </div>
                <div class="section">
                    <div class="section-title">Status Filter</div>
                    <ul class="filter-list" id="statusFilter">
                        <li class="filter-item active" data-status="all">
                            <i class="fas fa-circle"></i> Alle
                        </li>
                        <li class="filter-item" data-status="geplant">
                            <i class="fas fa-circle" style="color: #3b82f6;"></i> Geplant
                        </li>
                        <li class="filter-item" data-status="freigegeben">
                            <i class="fas fa-circle" style="color: #10b981;"></i> Freigegeben
                        </li>
                        <li class="filter-item" data-status="inArbeit">
                            <i class="fas fa-circle" style="color: #2563eb;"></i> In Arbeit
                        </li>
                        <li class="filter-item" data-status="fertig">
                            <i class="fas fa-circle" style="color: #10b981;"></i> Fertig
                        </li>
                        <li class="filter-item" data-status="blockiert">
                            <i class="fas fa-circle" style="color: #ef4444;"></i> Blockiert
                        </li>
                        <li class="filter-item" data-status="störung">
                            <i class="fas fa-circle" style="color: #f97316;"></i> Störung
                        </li>
                    </ul>
                </div>
                <div class="section">
                    <div class="section-title">Schnellaktionen</div>
                    <button class="btn btn-sm" id="quickAddJob" style="width: 100%; margin-bottom: 0.5rem;">
                        <i class="fas fa-plus"></i> Neuer Auftrag
                    </button>
                    <button class="btn btn-sm" id="manageShiftsBtn" style="width: 100%;">
                        <i class="fas fa-clock"></i> Schichten verwalten
                    </button>
                </div>
            </div>
        </div>

        <!-- Planning Board -->
        <div class="planning-board">
            <div class="board-header">
                <div class="view-tabs">
                    <button class="view-tab active" data-view="week">Woche</button>
                    <button class="view-tab" data-view="day">Tag</button>
                    <button class="view-tab" data-view="list">Liste</button>
                </div>
                <div>
                    <button class="btn btn-sm" id="collapseBacklogBtn">
                        <i class="fas fa-chevron-right"></i> Backlog
                    </button>
                </div>
            </div>
            <div class="board-content" id="boardContent">
                <!-- Week View -->
                <div class="week-view" id="weekView">
                    <div class="week-header">
                        <div class="resource-header">Arbeitsbereich</div>
                        <div class="days-header" id="daysHeader">
                            <!-- Dynamically populated -->
                        </div>
                    </div>
                    <div class="week-body" id="weekBody">
                        <!-- Dynamically populated -->
                    </div>
                </div>
                
                <!-- Day View (hidden by default) -->
                <div class="day-view" id="dayView" style="display: none;">
                    <div style="padding: 1rem; text-align: center;">
                        <h3>Tagesansicht in Entwicklung</h3>
                        <p>Detailierte Tagesansicht mit Stundenraster</p>
                    </div>
                </div>
                
                <!-- List View (hidden by default) -->
                <div class="list-view" id="listView" style="display: none;">
                    <div style="padding: 1rem;">
                        <h3>Listenansicht</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Auftrag</th>
                                    <th>Arbeitsbereich</th>
                                    <th>Start</th>
                                    <th>Ende</th>
                                    <th>Status</th>
                                    <th>Priorität</th>
                                </tr>
                            </thead>
                            <tbody id="listViewBody">
                                <!-- Dynamically populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Backlog -->
        <div class="backlog" id="backlog">
            <div class="backlog-header">
                <span>Backlog</span>
                <div>
                    <button class="btn btn-icon btn-sm" id="backlogSearchToggle">
                        <i class="fas fa-search"></i>
                    </button>
                    <button class="btn btn-icon btn-sm" id="addBacklogJobBtn">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            <div class="backlog-content">
                <div class="search-box" id="backlogSearch" style="display: none;">
                    <input type="text" class="search-input" id="backlogSearchInput" placeholder="Suche nach Artikel oder Bezeichnung...">
                    <i class="fas fa-search search-icon"></i>
                </div>
                <ul class="backlog-list" id="backlogList">
                    <!-- Dynamically populated -->
                </ul>
                <div class="load-more">
                    <button class="btn btn-sm" id="loadMoreBacklog">
                        <i class="fas fa-chevron-down"></i> Mehr laden (30)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Job Editor Modal -->
    <div class="modal-overlay" id="jobEditorModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Auftrag bearbeiten</div>
                <button class="modal-close" id="closeJobEditor">&times;</button>
            </div>
            <div class="modal-body">
                <form id="jobForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Artikelnummer *</label>
                            <input type="text" class="form-control" id="artikelNr" list="productList" required>
                            <datalist id="productList"></datalist>
                            <div class="validation-error" id="artikelNrError">Artikelnummer ist erforderlich</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Bezeichnung *</label>
                            <input type="text" class="form-control" id="bezeichnung" required>
                            <div class="validation-error" id="bezeichnungError">Bezeichnung ist erforderlich</div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Menge/Batch *</label>
                            <input type="number" class="form-control" id="menge" min="1" step="1" value="1" required>
                            <div class="validation-error" id="mengeError">Menge muss größer als 0 sein</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Priorität *</label>
                            <select class="form-control" id="priorität" required>
                                <option value="1">1 - Höchste</option>
                                <option value="2">2 - Hoch</option>
                                <option value="3">3 - Mittel</option>
                                <option value="4">4 - Niedrig</option>
                                <option value="5" selected>5 - Niedrigste</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Arbeitsbereich</label>
                            <select class="form-control" id="workAreaId">
                                <option value="">-- Backlog (ungeplant) --</option>
                                <!-- Dynamically populated -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Schicht</label>
                            <select class="form-control" id="shiftTemplateId">
                                <option value="">-- Automatisch --</option>
                                <!-- Dynamically populated -->
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Start *</label>
                            <input type="datetime-local" class="form-control" id="start" required>
                            <div class="validation-error" id="startError">Start muss vor Ende liegen</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ende *</label>
                            <input type="datetime-local" class="form-control" id="end" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Setup (Minuten)</label>
                            <input type="number" class="form-control" id="setupMin" min="0" step="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Laufzeit (Minuten)</label>
                            <input type="number" class="form-control" id="laufzeitMin" min="1" step="1">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-control" id="status">
                                <option value="geplant">Geplant</option>
                                <option value="freigegeben">Freigegeben</option>
                                <option value="inArbeit">In Arbeit</option>
                                <option value="fertig">Fertig</option>
                                <option value="blockiert">Blockiert</option>
                                <option value="störung">Störung</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Farbe</label>
                            <div class="color-picker" id="colorPicker">
                                <div class="color-option" style="background: #3b82f6;" data-color="#3b82f6"></div>
                                <div class="color-option" style="background: #10b981;" data-color="#10b981"></div>
                                <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b"></div>
                                <div class="color-option" style="background: #ef4444;" data-color="#ef4444"></div>
                                <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6"></div>
                                <div class="color-option" style="background: #ec4899;" data-color="#ec4899"></div>
                                <div class="color-option" style="background: #6366f1;" data-color="#6366f1"></div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notiz</label>
                        <textarea class="form-control" id="notiz" rows="3"></textarea>
                    </div>
                    <div class="form-group" id="conflictWarning" style="display: none;">
                        <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 0.75rem;">
                            <strong><i class="fas fa-exclamation-triangle"></i> Warnung:</strong>
                            <span id="conflictText">Überlappung mit anderen Aufträgen oder außerhalb der Schicht!</span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelJobEditor">Abbrechen</button>
                <button class="btn btn-danger" id="deleteJobBtn" style="display: none;">Löschen</button>
                <button class="btn" id="duplicateJobBtn" style="display: none;">Duplizieren</button>
                <button class="btn btn-primary" id="saveJobBtn">Speichern</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title">Einstellungen & Administration</div>
                <button class="modal-close" id="closeSettings">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <button class="tab active" data-tab="workareas">Arbeitsbereiche</button>
                    <button class="tab" data-tab="shifts">Schichten</button>
                    <button class="tab" data-tab="products">Produktstamm</button>
                    <button class="tab" data-tab="import">Import</button>
                    <button class="tab" data-tab="data">Datenmanagement</button>
                </div>
                
                <!-- WorkAreas Tab -->
                <div class="tab-content active" id="tab-workareas">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4>Arbeitsbereiche verwalten</h4>
                        <button class="btn btn-sm" id="addWorkAreaModalBtn">
                            <i class="fas fa-plus"></i> Neu
                        </button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Schichten</th>
                                <th>Kapazität</th>
                                <th>Status</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="workareasTableBody">
                            <!-- Dynamically populated -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Shifts Tab -->
                <div class="tab-content" id="tab-shifts">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4>Schichtvorlagen verwalten</h4>
                        <button class="btn btn-sm" id="addShiftTemplateBtn">
                            <i class="fas fa-plus"></i> Neu
                        </button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Zeitfenster</th>
                                <th>Pause (min)</th>
                                <th>Farbe</th>
                                <th>Status</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="shiftsTableBody">
                            <!-- Dynamically populated -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Products Tab -->
                <div class="tab-content" id="tab-products">
                    <h4>Produktstamm (KPI)</h4>
                    <p style="margin-bottom: 1rem; font-size: 0.875rem;">
                        Importieren Sie Produktstammdaten per CSV mit folgenden Spalten:<br>
                        <code>artikelNr;bezeichnung;arbeitsbereichDefault;laufzeitMin;setupMin;bemerkung</code>
                    </p>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">CSV Datei auswählen</label>
                            <input type="file" class="form-control" id="productCsvFile" accept=".csv">
                        </div>
                        <div class="form-group" style="align-self: flex-end;">
                            <button class="btn btn-primary" id="importProductsBtn">Importieren</button>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem;">
                        <h5>Vorhandene Produkte (<span id="productCount">0</span>)</h5>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ArtikelNr</th>
                                        <th>Bezeichnung</th>
                                        <th>Laufzeit</th>
                                        <th>Setup</th>
                                        <th>Standard-Bereich</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTableBody">
                                    <!-- Dynamically populated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Import Tab -->
                <div class="tab-content" id="tab-import">
                    <h4>Backlog-Import</h4>
                    <p style="margin-bottom: 1rem; font-size: 0.875rem;">
                        Importieren Sie Aufträge per CSV mit folgenden Spalten:<br>
                        <code>id;artikelNr;bezeichnung;menge;priorität;wunschtermin</code> (optional)
                    </p>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">CSV Datei auswählen</label>
                            <input type="file" class="form-control" id="backlogCsvFile" accept=".csv">
                        </div>
                        <div class="form-group" style="align-self: flex-end;">
                            <button class="btn btn-primary" id="importBacklogBtn">Importieren</button>
                        </div>
                    </div>
                </div>
                
                <!-- Data Management Tab -->
                <div class="tab-content" id="tab-data">
                    <h4>Datenmanagement</h4>
                    <div class="form-group">
                        <label class="form-label">JSON-Daten exportieren</label>
                        <button class="btn btn-primary" id="exportJsonBtn" style="width: 100%;">
                            <i class="fas fa-download"></i> Vollständigen Datensatz exportieren
                        </button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">JSON-Daten importieren</label>
                        <div class="form-row">
                            <div class="form-group">
                                <input type="file" class="form-control" id="importJsonFile" accept=".json">
                            </div>
                            <div class="form-group">
                                <select class="form-control" id="importStrategy">
                                    <option value="merge">Merge (bestehende Daten beibehalten)</option>
                                    <option value="overwrite">Überschreiben (alle Daten ersetzen)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button class="btn btn-primary" id="importJsonBtn">Importieren</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Admin-PIN</label>
                        <div class="form-row">
                            <div class="form-group">
                                <input type="password" class="form-control" id="adminPin" value="1234" placeholder="Admin PIN">
                            </div>
                            <div class="form-group">
                                <button class="btn btn-danger" id="resetDataBtn">
                                    <i class="fas fa-trash"></i> Feinplanungsdaten zurücksetzen
                                </button>
                            </div>
                        </div>
                        <p style="font-size: 0.875rem; color: var(--gray-600);">
                            Warnung: Setzt alle Aufträge und Planungen zurück, behält Stammdaten bei.
                        </p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="closeSettingsBtn">Schließen</button>
            </div>
        </div>
    </div>

    <!-- WorkArea Editor Drawer -->
    <div class="drawer" id="workAreaDrawer">
        <div class="modal-header">
            <div class="modal-title" id="workAreaDrawerTitle">Neuer Arbeitsbereich</div>
            <button class="modal-close" id="closeWorkAreaDrawer">&times;</button>
        </div>
        <div class="modal-body">
            <form id="workAreaForm">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" class="form-control" id="workAreaName" required>
                    <div class="validation-error" id="workAreaNameError">Name ist erforderlich</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Beschreibung (optional)</label>
                    <textarea class="form-control" id="workAreaDescription" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Kapazitäts-Multiplikator</label>
                    <input type="number" class="form-control" id="workAreaMultiplier" min="0.1" step="0.1" value="1.0">
                    <div style="font-size: 0.875rem; color: var(--gray-600);">
                        1.0 = Normalkapazität, 1.5 = 150% Kapazität, etc.
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Schichtvorlagen *</label>
                    <div id="shiftTemplatesCheckboxes">
                        <!-- Dynamically populated -->
                    </div>
                    <div class="validation-error" id="workAreaShiftsError">Mindestens eine Schichtvorlage muss ausgewählt werden</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Standard-Schicht</label>
                    <select class="form-control" id="workAreaDefaultShift">
                        <option value="">-- Keine Standard-Schicht --</option>
                        <!-- Dynamically populated -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Farbe</label>
                    <div class="color-picker" id="workAreaColorPicker">
                        <div class="color-option" style="background: #3b82f6;" data-color="#3b82f6"></div>
                        <div class="color-option" style="background: #10b981;" data-color="#10b981"></div>
                        <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b"></div>
                        <div class="color-option" style="background: #ef4444;" data-color="#ef4444"></div>
                        <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6"></div>
                        <div class="color-option" style="background: #ec4899;" data-color="#ec4899"></div>
                        <div class="color-option selected" style="background: #6366f1;" data-color="#6366f1"></div>
                    </div>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="workAreaActive" checked>
                    <label class="form-check-label">Aktiv</label>
                </div>
                <div class="form-group" id="workAreaImpactPreview" style="display: none;">
                    <div style="background: #f3f4f6; border-radius: var(--border-radius); padding: 1rem;">
                        <h5>Auswirkungsvorschau</h5>
                        <p id="workAreaImpactText">0 Jobs betroffen</p>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn" id="cancelWorkAreaBtn">Abbrechen</button>
            <button class="btn btn-danger" id="deleteWorkAreaBtn" style="display: none;">Löschen</button>
            <button class="btn btn-primary" id="saveWorkAreaBtn">Speichern</button>
        </div>
    </div>

    <!-- Shift Template Editor Drawer -->
    <div class="drawer" id="shiftTemplateDrawer">
        <div class="modal-header">
            <div class="modal-title" id="shiftTemplateDrawerTitle">Neue Schichtvorlage</div>
            <button class="modal-close" id="closeShiftTemplateDrawer">&times;</button>
        </div>
        <div class="modal-body">
            <form id="shiftTemplateForm">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" class="form-control" id="shiftTemplateName" required>
                    <div class="validation-error" id="shiftTemplateNameError">Name ist erforderlich</div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Startzeit *</label>
                        <input type="time" class="form-control" id="shiftTemplateStart" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Endzeit *</label>
                        <input type="time" class="form-control" id="shiftTemplateEnd" required>
                        <div class="validation-error" id="shiftTemplateTimeError">Endzeit muss nach Startzeit liegen (über Mitternacht möglich)</div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Pause (Minuten)</label>
                    <input type="number" class="form-control" id="shiftTemplateBreak" min="0" step="1" value="30">
                </div>
                <div class="form-group">
                    <label class="form-label">Farbe</label>
                    <div class="color-picker" id="shiftTemplateColorPicker">
                        <div class="color-option" style="background: #3b82f6;" data-color="#3b82f6"></div>
                        <div class="color-option" style="background: #10b981;" data-color="#10b981"></div>
                        <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b"></div>
                        <div class="color-option" style="background: #ef4444;" data-color="#ef4444"></div>
                        <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6"></div>
                        <div class="color-option" style="background: #ec4899;" data-color="#ec4899"></div>
                        <div class="color-option selected" style="background: #6366f1;" data-color="#6366f1"></div>
                    </div>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="shiftTemplateActive" checked>
                    <label class="form-check-label">Aktiv</label>
                </div>
                <div class="form-group" id="shiftTemplateImpactPreview" style="display: none;">
                    <div style="background: #f3f4f6; border-radius: var(--border-radius); padding: 1rem;">
                        <h5>Auswirkungsvorschau</h5>
                        <p id="shiftTemplateImpactText">0 Arbeitsbereiche und 0 Jobs betroffen</p>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn" id="cancelShiftTemplateBtn">Abbrechen</button>
            <button class="btn btn-danger" id="deleteShiftTemplateBtn" style="display: none;">Löschen</button>
            <button class="btn btn-primary" id="saveShiftTemplateBtn">Speichern</button>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- JavaScript -->
    <script>
        // ============================================
        // MODULE: Storage Manager
        // ============================================
        const StorageManager = (function() {
            const STORAGE_KEY = 'feinplanung_app_data';
            const SCHEMA_VERSION = 1;
            
            function getDefaultData() {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                
                return {
                    schemaVersion: SCHEMA_VERSION,
                    workAreas: [],
                    shiftTemplates: [
                        {
                            id: 'shift1',
                            name: 'Frühschicht',
                            startTime: '05:00',
                            endTime: '14:00',
                            breakMinutes: 30,
                            colorTag: '#3b82f6',
                            active: true,
                            sortIndex: 0
                        },
                        {
                            id: 'shift2',
                            name: 'Spätschicht',
                            startTime: '14:00',
                            endTime: '22:50',
                            breakMinutes: 30,
                            colorTag: '#10b981',
                            active: true,
                            sortIndex: 1
                        }
                    ],
                    products: [],
                    jobs: [],
                    settings: {
                        currentRole: 'ADMIN',
                        adminPin: '1234',
                        currentDate: today.toISOString(),
                        currentView: 'week',
                        statusFilter: 'all',
                        backlogItemsPerPage: 30
                    }
                };
            }
            
            function loadData() {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (!stored) {
                    const defaultData = getDefaultData();
                    saveData(defaultData);
                    return defaultData;
                }
                
                try {
                    const data = JSON.parse(stored);
                    // Schema migration logic could go here
                    if (data.schemaVersion !== SCHEMA_VERSION) {
                        // Migration logic
                        data.schemaVersion = SCHEMA_VERSION;
                        saveData(data);
                    }
                    return data;
                } catch (e) {
                    console.error('Failed to parse stored data:', e);
                    const defaultData = getDefaultData();
                    saveData(defaultData);
                    return defaultData;
                }
            }
            
            function saveData(data) {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                    return true;
                } catch (e) {
                    console.error('Failed to save data:', e);
                    return false;
                }
            }
            
            function exportData() {
                const data = loadData();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `feinplanung_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            function importData(jsonData, strategy) {
                const currentData = loadData();
                let newData;
                
                try {
                    newData = JSON.parse(jsonData);
                } catch (e) {
                    throw new Error('Ungültiges JSON-Format');
                }
                
                if (strategy === 'overwrite') {
                    // Keep schema version and maybe some settings
                    newData.schemaVersion = SCHEMA_VERSION;
                    if (!newData.settings) newData.settings = currentData.settings;
                    newData.settings.currentRole = currentData.settings.currentRole;
                    saveData(newData);
                } else { // merge
                    // Merge arrays by id
                    const mergeArrays = (currentArray, newArray) => {
                        const merged = [...currentArray];
                        newArray.forEach(newItem => {
                            const index = merged.findIndex(item => item.id === newItem.id);
                            if (index >= 0) {
                                merged[index] = newItem;
                            } else {
                                merged.push(newItem);
                            }
                        });
                        return merged;
                    };
                    
                    const mergedData = {
                        ...currentData,
                        workAreas: mergeArrays(currentData.workAreas, newData.workAreas || []),
                        shiftTemplates: mergeArrays(currentData.shiftTemplates, newData.shiftTemplates || []),
                        products: (newData.products || []).length > 0 ? newData.products : currentData.products,
                        jobs: mergeArrays(currentData.jobs, newData.jobs || []),
                        settings: { ...currentData.settings, ...(newData.settings || {}) }
                    };
                    
                    mergedData.schemaVersion = SCHEMA_VERSION;
                    saveData(mergedData);
                }
                
                return true;
            }
            
            function resetPlanningData() {
                const data = loadData();
                // Keep workAreas, shiftTemplates, products, and settings
                data.jobs = [];
                data.settings.currentDate = new Date().toISOString();
                saveData(data);
                return data;
            }
            
            return {
                loadData,
                saveData,
                exportData,
                importData,
                resetPlanningData
            };
        })();

        // ============================================
        // MODULE: State Manager
        // ============================================
        const StateManager = (function() {
            let state = StorageManager.loadData();
            let listeners = [];
            
            function getState() {
                return { ...state };
            }
            
            function setState(newState) {
                state = { ...newState };
                StorageManager.saveData(state);
                listeners.forEach(listener => listener(state));
            }
            
            function updateState(updater) {
                const newState = { ...state };
                updater(newState);
                setState(newState);
            }
            
            function subscribe(listener) {
                listeners.push(listener);
                return () => {
                    listeners = listeners.filter(l => l !== listener);
                };
            }
            
            // Helper getters
            function getWorkArea(id) {
                return state.workAreas.find(wa => wa.id === id);
            }
            
            function getShiftTemplate(id) {
                return state.shiftTemplates.find(st => st.id === id);
            }
            
            function getProduct(artikelNr) {
                return state.products.find(p => p.artikelNr === artikelNr);
            }
            
            function getJobsForWorkArea(workAreaId, dateRange = null) {
                let jobs = state.jobs.filter(job => job.workAreaId === workAreaId);
                if (dateRange) {
                    const { start, end } = dateRange;
                    jobs = jobs.filter(job => {
                        const jobStart = new Date(job.start);
                        const jobEnd = new Date(job.end);
                        return (jobStart < end && jobEnd > start);
                    });
                }
                return jobs;
            }
            
            function getBacklogJobs(searchTerm = '', statusFilter = 'all') {
                let jobs = state.jobs.filter(job => !job.workAreaId);
                
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    jobs = jobs.filter(job => 
                        job.artikelNr.toLowerCase().includes(term) ||
                        job.bezeichnung.toLowerCase().includes(term)
                    );
                }
                
                if (statusFilter !== 'all') {
                    jobs = jobs.filter(job => job.status === statusFilter);
                }
                
                return jobs.sort((a, b) => {
                    if (a.priorität !== b.priorität) return a.priorität - b.priorität;
                    return new Date(a.createdAt) - new Date(b.createdAt);
                });
            }
            
            function getConflictingJobs(job, excludeId = null) {
                if (!job.workAreaId || !job.start || !job.end) return [];
                
                const jobStart = new Date(job.start);
                const jobEnd = new Date(job.end);
                
                return state.jobs.filter(other => {
                    if (other.id === excludeId) return false;
                    if (other.workAreaId !== job.workAreaId) return false;
                    if (!other.start || !other.end) return false;
                    
                    const otherStart = new Date(other.start);
                    const otherEnd = new Date(other.end);
                    
                    return (jobStart < otherEnd && jobEnd > otherStart);
                });
            }
            
            function isWithinShift(job, workArea) {
                if (!workArea || !job.start || !job.end) return true;
                
                const jobStart = new Date(job.start);
                const jobEnd = new Date(job.end);
                const jobDate = new Date(jobStart.getFullYear(), jobStart.getMonth(), jobStart.getDate());
                
                // Check all shifts for this workArea
                for (const shiftId of workArea.shiftTemplateIds) {
                    const shift = getShiftTemplate(shiftId);
                    if (!shift || !shift.active) continue;
                    
                    const shiftStart = parseTime(shift.startTime, jobDate);
                    let shiftEnd = parseTime(shift.endTime, jobDate);
                    if (shiftEnd < shiftStart) shiftEnd.setDate(shiftEnd.getDate() + 1);
                    
                    // Adjust for break
                    const shiftEndAfterBreak = new Date(shiftEnd.getTime() - shift.breakMinutes * 60000);
                    
                    if (jobStart >= shiftStart && jobEnd <= shiftEndAfterBreak) {
                        return true;
                    }
                }
                
                return false;
            }
            
            function parseTime(timeStr, baseDate) {
                const [hours, minutes] = timeStr.split(':').map(Number);
                const date = new Date(baseDate);
                date.setHours(hours, minutes, 0, 0);
                return date;
            }
            
            function calculateCapacity(workAreaId, date) {
                const workArea = getWorkArea(workAreaId);
                if (!workArea || !workArea.active) return { available: 0, used: 0 };
                
                const dayStart = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                const dayEnd = new Date(dayStart.getTime() + 86400000);
                
                let availableMinutes = 0;
                workArea.shiftTemplateIds.forEach(shiftId => {
                    const shift = getShiftTemplate(shiftId);
                    if (!shift || !shift.active) return;
                    
                    const shiftStart = parseTime(shift.startTime, dayStart);
                    let shiftEnd = parseTime(shift.endTime, dayStart);
                    if (shiftEnd < shiftStart) shiftEnd.setDate(shiftEnd.getDate() + 1);
                    
                    const shiftDuration = (shiftEnd - shiftStart) / 60000;
                    availableMinutes += shiftDuration - shift.breakMinutes;
                });
                
                availableMinutes *= workArea.capacityMultiplier;
                
                // Calculate used minutes
                const jobs = getJobsForWorkArea(workAreaId, { start: dayStart, end: dayEnd });
                let usedMinutes = 0;
                jobs.forEach(job => {
                    const jobStart = new Date(job.start);
                    const jobEnd = new Date(job.end);
                    const jobDuration = (jobEnd - jobStart) / 60000;
                    usedMinutes += jobDuration;
                });
                
                return {
                    available: Math.round(availableMinutes),
                    used: Math.round(usedMinutes),
                    percentage: availableMinutes > 0 ? Math.min(100, Math.round((usedMinutes / availableMinutes) * 100)) : 0
                };
            }
            
            return {
                getState,
                updateState,
                subscribe,
                getWorkArea,
                getShiftTemplate,
                getProduct,
                getJobsForWorkArea,
                getBacklogJobs,
                getConflictingJobs,
                isWithinShift,
                calculateCapacity
            };
        })();

        // ============================================
        // MODULE: UI Manager
        // ============================================
        const UIManager = (function() {
            let currentJobEditorId = null;
            let currentWorkAreaEditorId = null;
            let currentShiftTemplateEditorId = null;
            
            function init() {
                setupEventListeners();
                renderAll();
                
                // Initial render
                StateManager.subscribe(renderAll);
            }
            
            function setupEventListeners() {
                // Topbar controls
                document.getElementById('todayBtn').addEventListener('click', () => {
                    StateManager.updateState(state => {
                        state.settings.currentDate = new Date().toISOString();
                    });
                });
                
                document.getElementById('prevBtn').addEventListener('click', () => {
                    navigateDate(-1);
                });
                
                document.getElementById('nextBtn').addEventListener('click', () => {
                    navigateDate(1);
                });
                
                document.getElementById('viewSelect').addEventListener('change', (e) => {
                    StateManager.updateState(state => {
                        state.settings.currentView = e.target.value;
                    });
                });
                
                document.getElementById('exportBtn').addEventListener('click', () => {
                    StorageManager.exportData();
                    showToast('Daten exportiert', 'success');
                });
                
                document.getElementById('importBtn').addEventListener('click', () => {
                    document.getElementById('settingsModal').classList.add('active');
                    showTab('data');
                });
                
                document.getElementById('settingsBtn').addEventListener('click', () => {
                    document.getElementById('settingsModal').classList.add('active');
                });
                
                document.getElementById('roleToggle').addEventListener('click', () => {
                    StateManager.updateState(state => {
                        state.settings.currentRole = state.settings.currentRole === 'ADMIN' ? 'USER' : 'ADMIN';
                    });
                });
                
                // Sidebar
                document.getElementById('sidebarToggle').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.toggle('collapsed');
                });
                
                document.getElementById('addWorkAreaBtn').addEventListener('click', () => {
                    if (!isAdmin()) return;
                    openWorkAreaEditor();
                });
                
                document.getElementById('quickAddJob').addEventListener('click', () => {
                    openJobEditor();
                });
                
                document.getElementById('manageShiftsBtn').addEventListener('click', () => {
                    document.getElementById('settingsModal').classList.add('active');
                    showTab('shifts');
                });
                
                // Status filter
                document.querySelectorAll('#statusFilter .filter-item').forEach(item => {
                    item.addEventListener('click', () => {
                        document.querySelectorAll('#statusFilter .filter-item').forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        StateManager.updateState(state => {
                            state.settings.statusFilter = item.dataset.status;
                        });
                    });
                });
                
                // Board controls
                document.querySelectorAll('.view-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        StateManager.updateState(state => {
                            state.settings.currentView = tab.dataset.view;
                        });
                    });
                });
                
                document.getElementById('collapseBacklogBtn').addEventListener('click', () => {
                    document.getElementById('backlog').classList.toggle('collapsed');
                    const icon = document.querySelector('#collapseBacklogBtn i');
                    icon.classList.toggle('fa-chevron-right');
                    icon.classList.toggle('fa-chevron-left');
                });
                
                // Backlog
                document.getElementById('backlogSearchToggle').addEventListener('click', () => {
                    const searchBox = document.getElementById('backlogSearch');
                    searchBox.style.display = searchBox.style.display === 'none' ? 'block' : 'none';
                    if (searchBox.style.display === 'block') {
                        document.getElementById('backlogSearchInput').focus();
                    }
                });
                
                document.getElementById('backlogSearchInput').addEventListener('input', debounce(() => {
                    renderBacklog();
                }, 300));
                
                document.getElementById('addBacklogJobBtn').addEventListener('click', () => {
                    openJobEditor();
                });
                
                document.getElementById('loadMoreBacklog').addEventListener('click', () => {
                    const state = StateManager.getState();
                    StateManager.updateState(s => {
                        s.settings.backlogItemsPerPage += 30;
                    });
                });
                
                // Job editor
                document.getElementById('closeJobEditor').addEventListener('click', closeJobEditor);
                document.getElementById('cancelJobEditor').addEventListener('click', closeJobEditor);
                document.getElementById('saveJobBtn').addEventListener('click', saveJob);
                document.getElementById('deleteJobBtn').addEventListener('click', deleteJob);
                document.getElementById('duplicateJobBtn').addEventListener('click', duplicateJob);
                
                // Job editor form fields
                document.getElementById('artikelNr').addEventListener('input', function() {
                    const product = StateManager.getProduct(this.value);
                    if (product) {
                        document.getElementById('bezeichnung').value = product.bezeichnung;
                        document.getElementById('laufzeitMin').value = product.laufzeitMin;
                        document.getElementById('setupMin').value = product.setupMin;
                        
                        // Auto-set work area if default exists
                        if (product.arbeitsbereichDefault) {
                            const workAreaSelect = document.getElementById('workAreaId');
                            workAreaSelect.value = product.arbeitsbereichDefault;
                            updateShiftTemplatesForWorkArea(product.arbeitsbereichDefault);
                        }
                        
                        // Calculate end time if start is set
                        const startInput = document.getElementById('start');
                        if (startInput.value) {
                            calculateEndTime();
                        }
                    }
                });
                
                document.getElementById('start').addEventListener('change', calculateEndTime);
                document.getElementById('setupMin').addEventListener('input', calculateEndTime);
                document.getElementById('laufzeitMin').addEventListener('input', calculateEndTime);
                document.getElementById('workAreaId').addEventListener('change', function() {
                    updateShiftTemplatesForWorkArea(this.value);
                });
                
                // Settings modal
                document.getElementById('closeSettings').addEventListener('click', () => {
                    document.getElementById('settingsModal').classList.remove('active');
                });
                
                document.getElementById('closeSettingsBtn').addEventListener('click', () => {
                    document.getElementById('settingsModal').classList.remove('active');
                });
                
                // Close modals when clicking outside (on overlay background)
                document.getElementById('jobEditorModal').addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeJobEditor();
                    }
                });
                
                document.getElementById('settingsModal').addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
                
                
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', function() {
                        showTab(this.dataset.tab);
                    });
                });
                
                // WorkArea editor in settings
                document.getElementById('addWorkAreaModalBtn').addEventListener('click', openWorkAreaEditor);
                
                // Shift template editor
                document.getElementById('addShiftTemplateBtn').addEventListener('click', openShiftTemplateEditor);
                
                // CSV import
                document.getElementById('importProductsBtn').addEventListener('click', importProductsCSV);
                document.getElementById('importBacklogBtn').addEventListener('click', importBacklogCSV);
                
                // JSON import/export
                document.getElementById('exportJsonBtn').addEventListener('click', () => {
                    StorageManager.exportData();
                    showToast('Daten exportiert', 'success');
                    document.getElementById('settingsModal').classList.remove('active');
                });
                
                document.getElementById('importJsonBtn').addEventListener('click', importJson);
                
                // Reset data
                document.getElementById('resetDataBtn').addEventListener('click', resetPlanningData);
                
                // WorkArea drawer
                document.getElementById('closeWorkAreaDrawer').addEventListener('click', closeWorkAreaEditor);
                document.getElementById('cancelWorkAreaBtn').addEventListener('click', closeWorkAreaEditor);
                document.getElementById('saveWorkAreaBtn').addEventListener('click', saveWorkArea);
                document.getElementById('deleteWorkAreaBtn').addEventListener('click', deleteWorkArea);
                
                // Shift template drawer
                document.getElementById('closeShiftTemplateDrawer').addEventListener('click', closeShiftTemplateEditor);
                document.getElementById('cancelShiftTemplateBtn').addEventListener('click', closeShiftTemplateEditor);
                document.getElementById('saveShiftTemplateBtn').addEventListener('click', saveShiftTemplate);
                document.getElementById('deleteShiftTemplateBtn').addEventListener('click', deleteShiftTemplate);
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        closeJobEditor();
                        closeWorkAreaEditor();
                        closeShiftTemplateEditor();
                        if (document.getElementById('settingsModal').classList.contains('active')) {
                            document.getElementById('settingsModal').classList.remove('active');
                        }
                    }
                    
                    if (e.ctrlKey && e.key === 's' && document.getElementById('jobEditorModal').classList.contains('active')) {
                        e.preventDefault();
                        saveJob();
                    }
                    
                    if (e.ctrlKey && e.key === 'f') {
                        e.preventDefault();
                        const searchBox = document.getElementById('backlogSearch');
                        searchBox.style.display = 'block';
                        document.getElementById('backlogSearchInput').focus();
                    }
                });
                
                // Drag & drop
                setupDragAndDrop();
            }
            
            function navigateDate(days) {
                StateManager.updateState(state => {
                    const current = new Date(state.settings.currentDate);
                    current.setDate(current.getDate() + days);
                    state.settings.currentDate = current.toISOString();
                });
            }
            
            function showTab(tabName) {
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.tab === tabName);
                });
                
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.toggle('active', content.id === `tab-${tabName}`);
                });
                
                if (tabName === 'workareas') renderWorkAreasTable();
                if (tabName === 'shifts') renderShiftsTable();
                if (tabName === 'products') renderProductsTable();
            }
            
            function renderAll() {
                const state = StateManager.getState();
                const { currentDate, currentView, currentRole } = state.settings;
                
                // Update role badge
                const roleBadge = document.getElementById('roleBadge');
                roleBadge.textContent = currentRole;
                roleBadge.className = `role-badge role-${currentRole.toLowerCase()}`;
                
                // Update date display
                const date = new Date(currentDate);
                document.getElementById('currentDate').textContent = formatDate(date);
                
                // Update view
                document.getElementById('viewSelect').value = currentView;
                document.querySelectorAll('.view-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.view === currentView);
                });
                
                // Show/hide appropriate view
                document.getElementById('weekView').style.display = currentView === 'week' ? 'flex' : 'none';
                document.getElementById('dayView').style.display = currentView === 'day' ? 'block' : 'none';
                document.getElementById('listView').style.display = currentView === 'list' ? 'block' : 'none';
                
                // Render components based on view
                if (currentView === 'week') renderWeekView();
                if (currentView === 'list') renderListView();
                
                // Always render these
                renderWorkAreas();
                renderBacklog();
                renderProductAutocomplete();
            }
            
            function renderWeekView() {
                const state = StateManager.getState();
                const currentDate = new Date(state.settings.currentDate);
                
                // Get start of week (Monday)
                const startOfWeek = new Date(currentDate);
                const day = startOfWeek.getDay();
                const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is Sunday
                startOfWeek.setDate(diff);
                
                // Render week header
                const daysHeader = document.getElementById('daysHeader');
                daysHeader.innerHTML = '';
                
                for (let i = 0; i < 7; i++) {
                    const dayDate = new Date(startOfWeek);
                    dayDate.setDate(startOfWeek.getDate() + i);
                    
                    const dayColumn = document.createElement('div');
                    dayColumn.className = 'day-column';
                    
                    const dayTitle = document.createElement('div');
                    dayTitle.className = 'day-title';
                    dayTitle.textContent = formatDay(dayDate.getDay());
                    
                    const dayDateDiv = document.createElement('div');
                    dayDateDiv.className = 'day-date';
                    
                    const dateStr = `${dayDate.getDate().toString().padStart(2, '0')}.${(dayDate.getMonth() + 1).toString().padStart(2, '0')}.`;
                    
                    // Check if today
                    const today = new Date();
                    const isToday = dayDate.getDate() === today.getDate() && 
                                     dayDate.getMonth() === today.getMonth() && 
                                     dayDate.getFullYear() === today.getFullYear();
                    
                    if (isToday) {
                        const todaySpan = document.createElement('span');
                        todaySpan.className = 'day-today';
                        todaySpan.textContent = dateStr + ' (Heute)';
                        dayDateDiv.appendChild(todaySpan);
                    } else {
                        dayDateDiv.textContent = dateStr;
                    }
                    
                    dayColumn.appendChild(dayTitle);
                    dayColumn.appendChild(dayDateDiv);
                    daysHeader.appendChild(dayColumn);
                }
                
                // Render week body
                const weekBody = document.getElementById('weekBody');
                weekBody.innerHTML = '';
                
                const activeWorkAreas = state.workAreas
                    .filter(wa => state.settings.statusFilter === 'all' || wa.active)
                    .sort((a, b) => a.sortIndex - b.sortIndex);
                
                activeWorkAreas.forEach(workArea => {
                    const row = document.createElement('div');
                    row.className = 'resource-row';
                    row.dataset.workAreaId = workArea.id;
                    
                    // Resource cell
                    const resourceCell = document.createElement('div');
                    resourceCell.className = 'resource-cell';
                    
                    const resourceName = document.createElement('div');
                    resourceName.className = 'resource-name';
                    resourceName.innerHTML = `<span class="workarea-color" style="background: ${workArea.colorTag || '#6366f1'}"></span>${workArea.name}`;
                    
                    const resourceShifts = document.createElement('div');
                    resourceShifts.className = 'resource-shifts';
                    resourceShifts.textContent = workArea.shiftTemplateIds
                        .map(id => state.shiftTemplates.find(st => st.id === id)?.name)
                        .filter(Boolean)
                        .join(', ');
                    
                    // Capacity for each day
                    const capacityContainer = document.createElement('div');
                    capacityContainer.style.marginTop = '0.5rem';
                    
                    for (let i = 0; i < 7; i++) {
                        const dayDate = new Date(startOfWeek);
                        dayDate.setDate(startOfWeek.getDate() + i);
                        
                        const capacity = StateManager.calculateCapacity(workArea.id, dayDate);
                        const capacityBar = document.createElement('div');
                        capacityBar.className = 'capacity-bar';
                        capacityBar.title = `${capacity.used}/${capacity.available} Min (${capacity.percentage}%)`;
                        
                        const capacityFill = document.createElement('div');
                        capacityFill.className = 'capacity-fill';
                        capacityFill.style.width = `${Math.min(100, capacity.percentage)}%`;
                        
                        if (capacity.percentage > 90) capacityFill.classList.add('danger');
                        else if (capacity.percentage > 70) capacityFill.classList.add('warning');
                        
                        capacityBar.appendChild(capacityFill);
                        capacityContainer.appendChild(capacityBar);
                    }
                    
                    resourceCell.appendChild(resourceName);
                    resourceCell.appendChild(resourceShifts);
                    resourceCell.appendChild(capacityContainer);
                    
                    // Time slots for each day
                    const timeSlots = document.createElement('div');
                    timeSlots.className = 'time-slots';
                    
                    for (let i = 0; i < 7; i++) {
                        const daySlot = document.createElement('div');
                        daySlot.className = 'day-slot';
                        daySlot.dataset.dayIndex = i;
                        daySlot.dataset.workAreaId = workArea.id;
                        
                        // Add time markers
                        for (let h = 6; h <= 22; h += 2) {
                            const marker = document.createElement('div');
                            marker.className = 'time-marker';
                            marker.style.top = `${((h - 6) / 16) * 100}%`;
                            marker.dataset.time = `${h.toString().padStart(2, '0')}:00`;
                            daySlot.appendChild(marker);
                        }
                        
                        // Add existing jobs
                        const dayDate = new Date(startOfWeek);
                        dayDate.setDate(startOfWeek.getDate() + i);
                        const dayStart = new Date(dayDate.getFullYear(), dayDate.getMonth(), dayDate.getDate());
                        const dayEnd = new Date(dayStart.getTime() + 86400000);
                        
                        const jobs = StateManager.getJobsForWorkArea(workArea.id, { start: dayStart, end: dayEnd });
                        jobs.forEach(job => {
                            if (state.settings.statusFilter !== 'all' && job.status !== state.settings.statusFilter) return;
                            
                            const jobElement = createJobElement(job, dayStart);
                            daySlot.appendChild(jobElement);
                        });
                        
                        timeSlots.appendChild(daySlot);
                    }
                    
                    row.appendChild(resourceCell);
                    row.appendChild(timeSlots);
                    weekBody.appendChild(row);
                });
            }
            
            function createJobElement(job, dayStart) {
                const jobStart = new Date(job.start);
                const jobEnd = new Date(job.end);
                
                // Calculate position
                const dayStartTime = dayStart.getTime();
                const jobStartOffset = jobStart.getTime() - dayStartTime;
                const jobDuration = jobEnd.getTime() - jobStart.getTime();
                
                const topPercent = (jobStartOffset / 86400000) * 100;
                const heightPercent = (jobDuration / 86400000) * 100;
                
                const jobElement = document.createElement('div');
                jobElement.className = `job-card ${job.status}`;
                jobElement.style.top = `${Math.max(0, topPercent)}%`;
                jobElement.style.height = `${Math.min(100 - topPercent, heightPercent)}%`;
                jobElement.style.left = '2px';
                jobElement.style.right = '2px';
                jobElement.style.backgroundColor = job.colorTag ? adjustAlpha(job.colorTag, 0.2) : '';
                jobElement.style.borderLeftColor = job.colorTag || '';
                jobElement.dataset.jobId = job.id;
                jobElement.draggable = true;
                
                // Check for conflicts
                const conflicts = StateManager.getConflictingJobs(job);
                if (conflicts.length > 0) {
                    const badge = document.createElement('div');
                    badge.className = 'job-badge';
                    badge.textContent = '⚠ Überlappung';
                    jobElement.appendChild(badge);
                }
                
                // Check if within shift
                const workArea = StateManager.getWorkArea(job.workAreaId);
                if (workArea && !StateManager.isWithinShift(job, workArea)) {
                    const badge = document.createElement('div');
                    badge.className = 'job-badge';
                    badge.textContent = '⚠ Außerhalb Schicht';
                    badge.style.top = conflicts.length > 0 ? '18px' : '2px';
                    badge.style.backgroundColor = '#f59e0b';
                    jobElement.appendChild(badge);
                }
                
                const title = document.createElement('div');
                title.className = 'job-title';
                title.textContent = `${job.artikelNr}: ${job.bezeichnung}`;
                title.title = `${job.artikelNr}: ${job.bezeichnung}`;
                
                const time = document.createElement('div');
                time.className = 'job-time';
                time.textContent = `${formatTime(jobStart)} - ${formatTime(jobEnd)}`;
                
                jobElement.appendChild(title);
                jobElement.appendChild(time);
                
                // Click to edit
                jobElement.addEventListener('click', (e) => {
                    if (e.target.classList.contains('job-badge')) return;
                    openJobEditor(job.id);
                });
                
                return jobElement;
            }
            
            function renderWorkAreas() {
                const state = StateManager.getState();
                const list = document.getElementById('workareaList');
                list.innerHTML = '';
                
                const activeWorkAreas = state.workAreas
                    .filter(wa => wa.active)
                    .sort((a, b) => a.sortIndex - b.sortIndex);
                
                const inactiveWorkAreas = state.workAreas
                    .filter(wa => !wa.active)
                    .sort((a, b) => a.sortIndex - b.sortIndex);
                
                activeWorkAreas.forEach(workArea => {
                    const li = document.createElement('li');
                    li.className = 'workarea-item active';
                    li.draggable = true;
                    li.dataset.workAreaId = workArea.id;
                    
                    const capacity = StateManager.calculateCapacity(workArea.id, new Date(state.settings.currentDate));
                    
                    li.innerHTML = `
                        <div>
                            <div><span class="workarea-color" style="background: ${workArea.colorTag || '#6366f1'}"></span>${workArea.name}</div>
                            <div class="capacity-bar">
                                <div class="capacity-fill ${capacity.percentage > 90 ? 'danger' : capacity.percentage > 70 ? 'warning' : ''}" 
                                     style="width: ${Math.min(100, capacity.percentage)}%"></div>
                            </div>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--gray-600);">
                            ${capacity.used}/${capacity.available} Min
                        </div>
                    `;
                    
                    li.addEventListener('click', () => {
                        if (!isAdmin()) return;
                        openWorkAreaEditor(workArea.id);
                    });
                    
                    list.appendChild(li);
                });
                
                if (inactiveWorkAreas.length > 0) {
                    const separator = document.createElement('div');
                    separator.className = 'section-title';
                    separator.textContent = 'Inaktiv';
                    separator.style.marginTop = '1rem';
                    list.appendChild(separator);
                    
                    inactiveWorkAreas.forEach(workArea => {
                        const li = document.createElement('li');
                        li.className = 'workarea-item inactive';
                        li.dataset.workAreaId = workArea.id;
                        
                        li.innerHTML = `
                            <div>
                                <div><span class="workarea-color" style="background: ${workArea.colorTag || '#6366f1'}"></span>${workArea.name}</div>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray-600);">
                                <i class="fas fa-ban"></i>
                            </div>
                        `;
                        
                        li.addEventListener('click', () => {
                            if (!isAdmin()) return;
                            openWorkAreaEditor(workArea.id);
                        });
                        
                        list.appendChild(li);
                    });
                }
            }
            
            function renderBacklog() {
                const state = StateManager.getState();
                const searchTerm = document.getElementById('backlogSearchInput').value;
                const jobs = StateManager.getBacklogJobs(searchTerm, state.settings.statusFilter);
                const itemsPerPage = state.settings.backlogItemsPerPage;
                
                const list = document.getElementById('backlogList');
                list.innerHTML = '';
                
                const jobsToShow = jobs.slice(0, itemsPerPage);
                
                if (jobsToShow.length === 0) {
                    const empty = document.createElement('li');
                    empty.style.textAlign = 'center';
                    empty.style.padding = '2rem';
                    empty.style.color = 'var(--gray-500)';
                    empty.textContent = searchTerm ? 'Keine passenden Aufträge gefunden' : 'Backlog ist leer';
                    list.appendChild(empty);
                }
                
                jobsToShow.forEach(job => {
                    const li = document.createElement('li');
                    li.className = 'backlog-item';
                    li.draggable = true;
                    li.dataset.jobId = job.id;
                    
                    const priorityClass = `priority-${job.priorität}`;
                    
                    li.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.25rem;">
                            <div style="font-weight: 600;">${job.artikelNr}</div>
                            <div class="${priorityClass}">${job.priorität}</div>
                        </div>
                        <div style="font-size: 0.875rem; margin-bottom: 0.25rem;">${job.bezeichnung}</div>
                        <div style="font-size: 0.75rem; color: var(--gray-600);">
                            Menge: ${job.batchOderMenge} | Status: ${job.status}
                        </div>
                    `;
                    
                    li.addEventListener('click', () => {
                        openJobEditor(job.id);
                    });
                    
                    list.appendChild(li);
                });
                
                // Update load more button
                const loadMoreBtn = document.getElementById('loadMoreBacklog');
                if (jobs.length > itemsPerPage) {
                    loadMoreBtn.textContent = `Mehr laden (${itemsPerPage}/${jobs.length})`;
                    loadMoreBtn.style.display = 'block';
                } else {
                    loadMoreBtn.style.display = 'none';
                }
            }
            
            function renderListView() {
                const state = StateManager.getState();
                const tbody = document.getElementById('listViewBody');
                tbody.innerHTML = '';
                
                // Get planned jobs (next 7 days)
                const now = new Date();
                const nextWeek = new Date(now.getTime() + 7 * 86400000);
                
                const plannedJobs = state.jobs
                    .filter(job => job.workAreaId && job.start)
                    .filter(job => {
                        const jobStart = new Date(job.start);
                        return jobStart >= now && jobStart <= nextWeek;
                    })
                    .sort((a, b) => new Date(a.start) - new Date(b.start))
                    .slice(0, 50); // Limit to 50
                
                plannedJobs.forEach(job => {
                    const workArea = StateManager.getWorkArea(job.workAreaId);
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${job.artikelNr}: ${job.bezeichnung}</td>
                        <td>${workArea ? workArea.name : '-'}</td>
                        <td>${formatDateTime(new Date(job.start))}</td>
                        <td>${formatDateTime(new Date(job.end))}</td>
                        <td><span class="filter-item active" style="display: inline-block; padding: 0.125rem 0.5rem;">${job.status}</span></td>
                        <td><div class="priority-${job.priorität}" style="display: inline-block;">${job.priorität}</div></td>
                    `;
                    
                    tr.addEventListener('click', () => {
                        openJobEditor(job.id);
                    });
                    
                    tbody.appendChild(tr);
                });
            }
            
            function renderWorkAreasTable() {
                const state = StateManager.getState();
                const tbody = document.getElementById('workareasTableBody');
                tbody.innerHTML = '';
                
                state.workAreas
                    .sort((a, b) => a.sortIndex - b.sortIndex)
                    .forEach(workArea => {
                        const shifts = workArea.shiftTemplateIds
                            .map(id => state.shiftTemplates.find(st => st.id === id)?.name)
                            .filter(Boolean)
                            .join(', ');
                        
                        const capacity = StateManager.calculateCapacity(workArea.id, new Date());
                        
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>
                                <div><strong>${workArea.name}</strong></div>
                                <div style="font-size: 0.75rem; color: var(--gray-600);">${workArea.description || ''}</div>
                            </td>
                            <td>${shifts}</td>
                            <td>
                                <div>${capacity.used}/${capacity.available} Min</div>
                                <div class="capacity-bar" style="width: 100px;">
                                    <div class="capacity-fill ${capacity.percentage > 90 ? 'danger' : capacity.percentage > 70 ? 'warning' : ''}" 
                                         style="width: ${Math.min(100, capacity.percentage)}%"></div>
                                </div>
                            </td>
                            <td>
                                <span class="filter-item active" style="display: inline-block; padding: 0.125rem 0.5rem;">
                                    ${workArea.active ? 'Aktiv' : 'Inaktiv'}
                                </span>
                            </td>
                            <td>
                                <div class="table-actions">
                                    <button class="btn btn-icon btn-sm btn-edit-workarea" data-id="${workArea.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        
                        tbody.appendChild(tr);
                    });
                
                // Add event listeners to edit buttons
                document.querySelectorAll('.btn-edit-workarea').forEach(btn => {
                    btn.addEventListener('click', function() {
                        openWorkAreaEditor(this.dataset.id);
                    });
                });
            }
            
            function renderShiftsTable() {
                const state = StateManager.getState();
                const tbody = document.getElementById('shiftsTableBody');
                tbody.innerHTML = '';
                
                state.shiftTemplates
                    .sort((a, b) => a.sortIndex - b.sortIndex)
                    .forEach(shift => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td><strong>${shift.name}</strong></td>
                            <td>${shift.startTime} - ${shift.endTime}</td>
                            <td>${shift.breakMinutes}</td>
                            <td><span class="workarea-color" style="background: ${shift.colorTag || '#6366f1'}"></span></td>
                            <td>
                                <span class="filter-item active" style="display: inline-block; padding: 0.125rem 0.5rem;">
                                    ${shift.active ? 'Aktiv' : 'Inaktiv'}
                                </span>
                            </td>
                            <td>
                                <div class="table-actions">
                                    <button class="btn btn-icon btn-sm btn-edit-shift" data-id="${shift.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        
                        tbody.appendChild(tr);
                    });
                
                // Add event listeners to edit buttons
                document.querySelectorAll('.btn-edit-shift').forEach(btn => {
                    btn.addEventListener('click', function() {
                        openShiftTemplateEditor(this.dataset.id);
                    });
                });
            }
            
            function renderProductsTable() {
                const state = StateManager.getState();
                const tbody = document.getElementById('productsTableBody');
                tbody.innerHTML = '';
                
                state.products.forEach(product => {
                    const workArea = StateManager.getWorkArea(product.arbeitsbereichDefault);
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${product.artikelNr}</td>
                        <td>${product.bezeichnung}</td>
                        <td>${product.laufzeitMin} min</td>
                        <td>${product.setupMin} min</td>
                        <td>${workArea ? workArea.name : '-'}</td>
                    `;
                    
                    tbody.appendChild(tr);
                });
                
                document.getElementById('productCount').textContent = state.products.length;
            }
            
            function renderProductAutocomplete() {
                const state = StateManager.getState();
                const datalist = document.getElementById('productList');
                datalist.innerHTML = '';
                
                state.products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.artikelNr;
                    option.label = `${product.artikelNr} - ${product.bezeichnung}`;
                    datalist.appendChild(option);
                });
            }
            
            function openJobEditor(jobId = null) {
                currentJobEditorId = jobId;
                const modal = document.getElementById('jobEditorModal');
                const state = StateManager.getState();
                const isAdminUser = isAdmin();
                
                // Reset form
                document.getElementById('jobForm').reset();
                
                // Populate work areas dropdown
                const workAreaSelect = document.getElementById('workAreaId');
                workAreaSelect.innerHTML = '<option value="">-- Backlog (ungeplant) --</option>';
                state.workAreas
                    .filter(wa => wa.active)
                    .sort((a, b) => a.sortIndex - b.sortIndex)
                    .forEach(workArea => {
                        const option = document.createElement('option');
                        option.value = workArea.id;
                        option.textContent = workArea.name;
                        workAreaSelect.appendChild(option);
                    });
                
                // Populate color picker
                document.querySelectorAll('#colorPicker .color-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                document.querySelector('#colorPicker .color-option:first-child').classList.add('selected');
                
                if (jobId) {
                    // Edit existing job
                    const job = state.jobs.find(j => j.id === jobId);
                    if (!job) return;
                    
                    document.getElementById('artikelNr').value = job.artikelNr;
                    document.getElementById('bezeichnung').value = job.bezeichnung;
                    document.getElementById('menge').value = job.batchOderMenge;
                    document.getElementById('priorität').value = job.priorität;
                    document.getElementById('workAreaId').value = job.workAreaId || '';
                    document.getElementById('start').value = formatDateTimeLocal(new Date(job.start));
                    document.getElementById('end').value = formatDateTimeLocal(new Date(job.end));
                    document.getElementById('setupMin').value = job.setupMin || '';
                    document.getElementById('laufzeitMin').value = job.laufzeitMin || '';
                    document.getElementById('status').value = job.status;
                    document.getElementById('notiz').value = job.notiz || '';
                    
                    // Set color
                    if (job.colorTag) {
                        const colorOpt = document.querySelector(`#colorPicker .color-option[data-color="${job.colorTag}"]`);
                        if (colorOpt) {
                            document.querySelectorAll('#colorPicker .color-option').forEach(opt => opt.classList.remove('selected'));
                            colorOpt.classList.add('selected');
                        }
                    }
                    
                    // Update shift templates based on work area
                    updateShiftTemplatesForWorkArea(job.workAreaId);
                    if (job.shiftTemplateId) {
                        document.getElementById('shiftTemplateId').value = job.shiftTemplateId;
                    }
                    
                    // Check for conflicts and shift violations
                    const conflicts = StateManager.getConflictingJobs(job, job.id);
                    const workArea = StateManager.getWorkArea(job.workAreaId);
                    const withinShift = workArea ? StateManager.isWithinShift(job, workArea) : true;
                    
                    const conflictWarning = document.getElementById('conflictWarning');
                    const conflictText = document.getElementById('conflictText');
                    
                    let warnings = [];
                    if (conflicts.length > 0) {
                        warnings.push(`Überlappt mit ${conflicts.length} anderen Aufträgen`);
                    }
                    if (!withinShift) {
                        warnings.push('Außerhalb des Schichtfensters');
                    }
                    
                    if (warnings.length > 0) {
                        conflictText.textContent = warnings.join(' | ');
                        conflictWarning.style.display = 'block';
                    } else {
                        conflictWarning.style.display = 'none';
                    }
                    
                    // Show delete and duplicate buttons for admin
                    document.getElementById('deleteJobBtn').style.display = isAdminUser ? 'inline-block' : 'none';
                    document.getElementById('duplicateJobBtn').style.display = isAdminUser ? 'inline-block' : 'none';
                    
                    document.getElementById('saveJobBtn').textContent = 'Speichern';
                } else {
                    // New job
                    const now = new Date();
                    const defaultStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 7, 0);
                    const defaultEnd = new Date(defaultStart.getTime() + 2 * 60 * 60000); // 2 hours later
                    
                    document.getElementById('start').value = formatDateTimeLocal(defaultStart);
                    document.getElementById('end').value = formatDateTimeLocal(defaultEnd);
                    document.getElementById('priorität').value = '5';
                    document.getElementById('status').value = 'geplant';
                    
                    document.getElementById('deleteJobBtn').style.display = 'none';
                    document.getElementById('duplicateJobBtn').style.display = 'none';
                    document.getElementById('conflictWarning').style.display = 'none';
                    document.getElementById('saveJobBtn').textContent = 'Erstellen';
                }
                
                // Disable form if user is not admin
                const formElements = document.querySelectorAll('#jobForm input, #jobForm select, #jobForm textarea');
                formElements.forEach(el => {
                    el.disabled = !isAdminUser;
                });
                document.getElementById('saveJobBtn').disabled = !isAdminUser;
                
                modal.classList.add('active');
                document.getElementById('artikelNr').focus();
            }
            
            function closeJobEditor() {
                document.getElementById('jobEditorModal').classList.remove('active');
                currentJobEditorId = null;
            }
            
            function saveJob() {
                if (!validateJobForm()) return;
                
                const formData = {
                    artikelNr: document.getElementById('artikelNr').value,
                    bezeichnung: document.getElementById('bezeichnung').value,
                    batchOderMenge: parseInt(document.getElementById('menge').value),
                    priorität: parseInt(document.getElementById('priorität').value),
                    workAreaId: document.getElementById('workAreaId').value || null,
                    shiftTemplateId: document.getElementById('shiftTemplateId').value || null,
                    start: document.getElementById('start').value,
                    end: document.getElementById('end').value,
                    setupMin: document.getElementById('setupMin').value ? parseInt(document.getElementById('setupMin').value) : null,
                    laufzeitMin: document.getElementById('laufzeitMin').value ? parseInt(document.getElementById('laufzeitMin').value) : null,
                    status: document.getElementById('status').value,
                    notiz: document.getElementById('notiz').value,
                    colorTag: document.querySelector('#colorPicker .color-option.selected')?.dataset.color || '#3b82f6'
                };
                
                StateManager.updateState(state => {
                    if (currentJobEditorId) {
                        // Update existing job
                        const index = state.jobs.findIndex(j => j.id === currentJobEditorId);
                        if (index >= 0) {
                            state.jobs[index] = {
                                ...state.jobs[index],
                                ...formData,
                                updatedAt: new Date().toISOString()
                            };
                        }
                    } else {
                        // Create new job
                        const newJob = {
                            id: 'job_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            ...formData,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        state.jobs.push(newJob);
                    }
                });
                
                showToast(currentJobEditorId ? 'Auftrag aktualisiert' : 'Auftrag erstellt', 'success');
                closeJobEditor();
            }
            
            function deleteJob() {
                if (!confirm('Auftrag wirklich löschen?')) return;
                
                StateManager.updateState(state => {
                    state.jobs = state.jobs.filter(j => j.id !== currentJobEditorId);
                });
                
                showToast('Auftrag gelöscht', 'success');
                closeJobEditor();
            }
            
            function duplicateJob() {
                if (!validateJobForm()) return;
                
                const formData = {
                    artikelNr: document.getElementById('artikelNr').value,
                    bezeichnung: document.getElementById('bezeichnung').value,
                    batchOderMenge: parseInt(document.getElementById('menge').value),
                    priorität: parseInt(document.getElementById('priorität').value),
                    workAreaId: document.getElementById('workAreaId').value || null,
                    shiftTemplateId: document.getElementById('shiftTemplateId').value || null,
                    start: document.getElementById('start').value,
                    end: document.getElementById('end').value,
                    setupMin: document.getElementById('setupMin').value ? parseInt(document.getElementById('setupMin').value) : null,
                    laufzeitMin: document.getElementById('laufzeitMin').value ? parseInt(document.getElementById('laufzeitMin').value) : null,
                    status: document.getElementById('status').value,
                    notiz: document.getElementById('notiz').value,
                    colorTag: document.querySelector('#colorPicker .color-option.selected')?.dataset.color || '#3b82f6'
                };
                
                StateManager.updateState(state => {
                    const newJob = {
                        id: 'job_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        ...formData,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    state.jobs.push(newJob);
                });
                
                showToast('Auftrag dupliziert', 'success');
                closeJobEditor();
            }
            
            function validateJobForm() {
                let isValid = true;
                
                // Clear previous errors
                document.querySelectorAll('.validation-error').forEach(el => {
                    el.classList.remove('show');
                });
                
                // Validate required fields
                if (!document.getElementById('artikelNr').value) {
                    document.getElementById('artikelNrError').classList.add('show');
                    isValid = false;
                }
                
                if (!document.getElementById('bezeichnung').value) {
                    document.getElementById('bezeichnungError').classList.add('show');
                    isValid = false;
                }
                
                const menge = parseInt(document.getElementById('menge').value);
                if (!menge || menge <= 0) {
                    document.getElementById('mengeError').classList.add('show');
                    isValid = false;
                }
                
                // Validate dates
                const start = new Date(document.getElementById('start').value);
                const end = new Date(document.getElementById('end').value);
                if (start >= end) {
                    document.getElementById('startError').classList.add('show');
                    isValid = false;
                }
                
                return isValid;
            }
            
            function calculateEndTime() {
                const startInput = document.getElementById('start');
                const setupInput = document.getElementById('setupMin');
                const runtimeInput = document.getElementById('laufzeitMin');
                
                if (!startInput.value) return;
                
                const start = new Date(startInput.value);
                const setup = setupInput.value ? parseInt(setupInput.value) : 0;
                const runtime = runtimeInput.value ? parseInt(runtimeInput.value) : 120; // Default 2 hours
                
                const end = new Date(start.getTime() + (setup + runtime) * 60000);
                document.getElementById('end').value = formatDateTimeLocal(end);
            }
            
            function updateShiftTemplatesForWorkArea(workAreaId) {
                const state = StateManager.getState();
                const shiftSelect = document.getElementById('shiftTemplateId');
                
                shiftSelect.innerHTML = '<option value="">-- Automatisch --</option>';
                
                if (workAreaId) {
                    const workArea = StateManager.getWorkArea(workAreaId);
                    if (workArea) {
                        workArea.shiftTemplateIds.forEach(shiftId => {
                            const shift = StateManager.getShiftTemplate(shiftId);
                            if (shift && shift.active) {
                                const option = document.createElement('option');
                                option.value = shift.id;
                                option.textContent = `${shift.name} (${shift.startTime}-${shift.endTime})`;
                                shiftSelect.appendChild(option);
                            }
                        });
                    }
                }
            }
            
            function openWorkAreaEditor(workAreaId = null) {
                if (!isAdmin()) {
                    showToast('Nur ADMIN kann Arbeitsbereiche bearbeiten', 'warning');
                    return;
                }
                
                currentWorkAreaEditorId = workAreaId;
                const drawer = document.getElementById('workAreaDrawer');
                const state = StateManager.getState();
                
                // Reset form
                document.getElementById('workAreaForm').reset();
                
                // Populate shift templates checkboxes
                const shiftsContainer = document.getElementById('shiftTemplatesCheckboxes');
                shiftsContainer.innerHTML = '';
                
                state.shiftTemplates
                    .sort((a, b) => a.sortIndex - b.sortIndex)
                    .forEach(shift => {
                        const div = document.createElement('div');
                        div.className = 'form-check';
                        div.innerHTML = `
                            <input type="checkbox" class="form-check-input shift-checkbox" id="shift_${shift.id}" value="${shift.id}">
                            <label class="form-check-label" for="shift_${shift.id}">
                                ${shift.name} (${shift.startTime}-${shift.endTime})
                            </label>
                        `;
                        shiftsContainer.appendChild(div);
                    });
                
                // Populate default shift dropdown
                const defaultShiftSelect = document.getElementById('workAreaDefaultShift');
                defaultShiftSelect.innerHTML = '<option value="">-- Keine Standard-Schicht --</option>';
                state.shiftTemplates
                    .filter(shift => shift.active)
                    .sort((a, b) => a.sortIndex - b.sortIndex)
                    .forEach(shift => {
                        const option = document.createElement('option');
                        option.value = shift.id;
                        option.textContent = shift.name;
                        defaultShiftSelect.appendChild(option);
                    });
                
                // Set up color picker
                document.querySelectorAll('#workAreaColorPicker .color-option').forEach(opt => {
                    opt.classList.remove('selected');
                    opt.addEventListener('click', function() {
                        document.querySelectorAll('#workAreaColorPicker .color-option').forEach(o => o.classList.remove('selected'));
                        this.classList.add('selected');
                    });
                });
                document.querySelector('#workAreaColorPicker .color-option:first-child').classList.add('selected');
                
                if (workAreaId) {
                    // Edit existing work area
                    const workArea = StateManager.getWorkArea(workAreaId);
                    if (!workArea) return;
                    
                    document.getElementById('workAreaDrawerTitle').textContent = 'Arbeitsbereich bearbeiten';
                    document.getElementById('workAreaName').value = workArea.name;
                    document.getElementById('workAreaDescription').value = workArea.description || '';
                    document.getElementById('workAreaMultiplier').value = workArea.capacityMultiplier || 1.0;
                    document.getElementById('workAreaActive').checked = workArea.active;
                    
                    // Select shift templates
                    workArea.shiftTemplateIds.forEach(shiftId => {
                        const checkbox = document.querySelector(`#shift_${shiftId}`);
                        if (checkbox) checkbox.checked = true;
                    });
                    
                    // Set default shift
                    if (workArea.defaultShiftTemplateId) {
                        document.getElementById('workAreaDefaultShift').value = workArea.defaultShiftTemplateId;
                    }
                    
                    // Set color
                    if (workArea.colorTag) {
                        const colorOpt = document.querySelector(`#workAreaColorPicker .color-option[data-color="${workArea.colorTag}"]`);
                        if (colorOpt) {
                            document.querySelectorAll('#workAreaColorPicker .color-option').forEach(opt => opt.classList.remove('selected'));
                            colorOpt.classList.add('selected');
                        }
                    }
                    
                    // Show impact preview
                    const impactPreview = document.getElementById('workAreaImpactPreview');
                    const impactText = document.getElementById('workAreaImpactText');
                    
                    const affectedJobs = state.jobs.filter(job => job.workAreaId === workAreaId);
                    impactText.textContent = `${affectedJobs.length} Jobs betroffen`;
                    impactPreview.style.display = 'block';
                    
                    // Show delete button
                    document.getElementById('deleteWorkAreaBtn').style.display = 'inline-block';
                } else {
                    // New work area
                    document.getElementById('workAreaDrawerTitle').textContent = 'Neuer Arbeitsbereich';
                    document.getElementById('workAreaActive').checked = true;
                    document.getElementById('workAreaImpactPreview').style.display = 'none';
                    document.getElementById('deleteWorkAreaBtn').style.display = 'none';
                }
                
                drawer.classList.add('active');
                document.getElementById('workAreaName').focus();
            }
            
            function closeWorkAreaEditor() {
                document.getElementById('workAreaDrawer').classList.remove('active');
                currentWorkAreaEditorId = null;
            }
            
            function saveWorkArea() {
                if (!validateWorkAreaForm()) return;
                
                const selectedShifts = Array.from(document.querySelectorAll('.shift-checkbox:checked'))
                    .map(cb => cb.value);
                
                if (selectedShifts.length === 0) {
                    document.getElementById('workAreaShiftsError').classList.add('show');
                    return;
                }
                
                const formData = {
                    name: document.getElementById('workAreaName').value,
                    description: document.getElementById('workAreaDescription').value,
                    capacityMultiplier: parseFloat(document.getElementById('workAreaMultiplier').value),
                    active: document.getElementById('workAreaActive').checked,
                    shiftTemplateIds: selectedShifts,
                    defaultShiftTemplateId: document.getElementById('workAreaDefaultShift').value || null,
                    colorTag: document.querySelector('#workAreaColorPicker .color-option.selected')?.dataset.color || '#3b82f6'
                };
                
                StateManager.updateState(state => {
                    if (currentWorkAreaEditorId) {
                        // Update existing
                        const index = state.workAreas.findIndex(wa => wa.id === currentWorkAreaEditorId);
                        if (index >= 0) {
                            state.workAreas[index] = {
                                ...state.workAreas[index],
                                ...formData
                            };
                        }
                    } else {
                        // Create new
                        const newWorkArea = {
                            id: 'wa_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            sortIndex: state.workAreas.length,
                            ...formData
                        };
                        state.workAreas.push(newWorkArea);
                    }
                });
                
                showToast(currentWorkAreaEditorId ? 'Arbeitsbereich aktualisiert' : 'Arbeitsbereich erstellt', 'success');
                closeWorkAreaEditor();
            }
            
            function deleteWorkArea() {
                if (!confirm('Arbeitsbereich wirklich löschen?\n\nBitte wählen Sie eine Strategie für vorhandene Jobs.')) {
                    return;
                }
                
                const strategy = prompt(
                    'Lösch-Strategie wählen:\n' +
                    '1 - Jobs auf anderen Arbeitsbereich migrieren\n' +
                    '2 - Jobs in Backlog verschieben\n' +
                    '3 - Jobs löschen\n\n' +
                    'Geben Sie 1, 2 oder 3 ein:'
                );
                
                if (!strategy || !['1', '2', '3'].includes(strategy)) {
                    showToast('Löschen abgebrochen', 'warning');
                    return;
                }
                
                if (strategy === '3') {
                    if (!confirm('ACHTUNG: Alle Jobs dieses Arbeitsbereichs werden unwiderruflich gelöscht!\nWirklich fortsetzen?')) {
                        return;
                    }
                }
                
                let targetWorkAreaId = null;
                if (strategy === '1') {
                    const state = StateManager.getState();
                    const otherWorkAreas = state.workAreas.filter(wa => wa.id !== currentWorkAreaEditorId && wa.active);
                    
                    if (otherWorkAreas.length === 0) {
                        showToast('Kein anderer aktiver Arbeitsbereich verfügbar', 'error');
                        return;
                    }
                    
                    const targetName = prompt(
                        'Ziel-Arbeitsbereich ID eingeben:\n' +
                        otherWorkAreas.map(wa => `${wa.id}: ${wa.name}`).join('\n')
                    );
                    
                    if (!targetName) {
                        showToast('Migration abgebrochen', 'warning');
                        return;
                    }
                    
                    targetWorkAreaId = targetName;
                }
                
                StateManager.updateState(state => {
                    if (strategy === '1' && targetWorkAreaId) {
                        // Migrate jobs to another work area
                        state.jobs.forEach(job => {
                            if (job.workAreaId === currentWorkAreaEditorId) {
                                job.workAreaId = targetWorkAreaId;
                            }
                        });
                    } else if (strategy === '2') {
                        // Move jobs to backlog
                        state.jobs.forEach(job => {
                            if (job.workAreaId === currentWorkAreaEditorId) {
                                job.workAreaId = null;
                                job.shiftTemplateId = null;
                            }
                        });
                    } else if (strategy === '3') {
                        // Delete jobs
                        state.jobs = state.jobs.filter(job => job.workAreaId !== currentWorkAreaEditorId);
                    }
                    
                    // Remove work area
                    state.workAreas = state.workAreas.filter(wa => wa.id !== currentWorkAreaEditorId);
                });
                
                showToast('Arbeitsbereich gelöscht', 'success');
                closeWorkAreaEditor();
            }
            
            function validateWorkAreaForm() {
                // Clear previous errors
                document.querySelectorAll('.validation-error').forEach(el => {
                    el.classList.remove('show');
                });
                
                if (!document.getElementById('workAreaName').value) {
                    document.getElementById('workAreaNameError').classList.add('show');
                    return false;
                }
                
                return true;
            }
            
            function openShiftTemplateEditor(shiftTemplateId = null) {
                if (!isAdmin()) {
                    showToast('Nur ADMIN kann Schichtvorlagen bearbeiten', 'warning');
                    return;
                }
                
                currentShiftTemplateEditorId = shiftTemplateId;
                const drawer = document.getElementById('shiftTemplateDrawer');
                const state = StateManager.getState();
                
                // Reset form
                document.getElementById('shiftTemplateForm').reset();
                
                // Set up color picker
                document.querySelectorAll('#shiftTemplateColorPicker .color-option').forEach(opt => {
                    opt.classList.remove('selected');
                    opt.addEventListener('click', function() {
                        document.querySelectorAll('#shiftTemplateColorPicker .color-option').forEach(o => o.classList.remove('selected'));
                        this.classList.add('selected');
                    });
                });
                document.querySelector('#shiftTemplateColorPicker .color-option:first-child').classList.add('selected');
                
                if (shiftTemplateId) {
                    // Edit existing shift template
                    const shift = StateManager.getShiftTemplate(shiftTemplateId);
                    if (!shift) return;
                    
                    document.getElementById('shiftTemplateDrawerTitle').textContent = 'Schichtvorlage bearbeiten';
                    document.getElementById('shiftTemplateName').value = shift.name;
                    document.getElementById('shiftTemplateStart').value = shift.startTime;
                    document.getElementById('shiftTemplateEnd').value = shift.endTime;
                    document.getElementById('shiftTemplateBreak').value = shift.breakMinutes;
                    document.getElementById('shiftTemplateActive').checked = shift.active;
                    
                    // Set color
                    if (shift.colorTag) {
                        const colorOpt = document.querySelector(`#shiftTemplateColorPicker .color-option[data-color="${shift.colorTag}"]`);
                        if (colorOpt) {
                            document.querySelectorAll('#shiftTemplateColorPicker .color-option').forEach(opt => opt.classList.remove('selected'));
                            colorOpt.classList.add('selected');
                        }
                    }
                    
                    // Show impact preview
                    const impactPreview = document.getElementById('shiftTemplateImpactPreview');
                    const impactText = document.getElementById('shiftTemplateImpactText');
                    
                    const affectedWorkAreas = state.workAreas.filter(wa => wa.shiftTemplateIds.includes(shiftTemplateId));
                    const affectedJobs = state.jobs.filter(job => job.shiftTemplateId === shiftTemplateId);
                    
                    impactText.textContent = `${affectedWorkAreas.length} Arbeitsbereiche und ${affectedJobs.length} Jobs betroffen`;
                    impactPreview.style.display = 'block';
                    
                    // Show delete button
                    document.getElementById('deleteShiftTemplateBtn').style.display = 'inline-block';
                } else {
                    // New shift template
                    document.getElementById('shiftTemplateDrawerTitle').textContent = 'Neue Schichtvorlage';
                    document.getElementById('shiftTemplateStart').value = '06:00';
                    document.getElementById('shiftTemplateEnd').value = '14:00';
                    document.getElementById('shiftTemplateBreak').value = 30;
                    document.getElementById('shiftTemplateActive').checked = true;
                    document.getElementById('shiftTemplateImpactPreview').style.display = 'none';
                    document.getElementById('deleteShiftTemplateBtn').style.display = 'none';
                }
                
                drawer.classList.add('active');
                document.getElementById('shiftTemplateName').focus();
            }
            
            function closeShiftTemplateEditor() {
                document.getElementById('shiftTemplateDrawer').classList.remove('active');
                currentShiftTemplateEditorId = null;
            }
            
            function saveShiftTemplate() {
                if (!validateShiftTemplateForm()) return;
                
                const formData = {
                    name: document.getElementById('shiftTemplateName').value,
                    startTime: document.getElementById('shiftTemplateStart').value,
                    endTime: document.getElementById('shiftTemplateEnd').value,
                    breakMinutes: parseInt(document.getElementById('shiftTemplateBreak').value),
                    active: document.getElementById('shiftTemplateActive').checked,
                    colorTag: document.querySelector('#shiftTemplateColorPicker .color-option.selected')?.dataset.color || '#3b82f6'
                };
                
                StateManager.updateState(state => {
                    if (currentShiftTemplateEditorId) {
                        // Update existing
                        const index = state.shiftTemplates.findIndex(st => st.id === currentShiftTemplateEditorId);
                        if (index >= 0) {
                            state.shiftTemplates[index] = {
                                ...state.shiftTemplates[index],
                                ...formData
                            };
                        }
                    } else {
                        // Create new
                        const newShiftTemplate = {
                            id: 'shift_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            sortIndex: state.shiftTemplates.length,
                            ...formData
                        };
                        state.shiftTemplates.push(newShiftTemplate);
                    }
                });
                
                showToast(currentShiftTemplateEditorId ? 'Schichtvorlage aktualisiert' : 'Schichtvorlage erstellt', 'success');
                closeShiftTemplateEditor();
            }
            
            function deleteShiftTemplate() {
                if (!confirm('Schichtvorlage wirklich löschen?\n\nBitte wählen Sie eine Strategie für betroffene Arbeitsbereiche und Jobs.')) {
                    return;
                }
                
                const strategy = prompt(
                    'Lösch-Strategie wählen:\n' +
                    '1 - Zu anderer Schicht migrieren\n' +
                    '2 - Schicht-Zuordnung entfernen\n\n' +
                    'Geben Sie 1 oder 2 ein:'
                );
                
                if (!strategy || !['1', '2'].includes(strategy)) {
                    showToast('Löschen abgebrochen', 'warning');
                    return;
                }
                
                let targetShiftId = null;
                if (strategy === '1') {
                    const state = StateManager.getState();
                    const otherShifts = state.shiftTemplates.filter(st => st.id !== currentShiftTemplateEditorId && st.active);
                    
                    if (otherShifts.length === 0) {
                        showToast('Keine andere aktive Schichtvorlage verfügbar', 'error');
                        return;
                    }
                    
                    const targetName = prompt(
                        'Ziel-Schicht ID eingeben:\n' +
                        otherShifts.map(st => `${st.id}: ${st.name}`).join('\n')
                    );
                    
                    if (!targetName) {
                        showToast('Migration abgebrochen', 'warning');
                        return;
                    }
                    
                    targetShiftId = targetName;
                }
                
                StateManager.updateState(state => {
                    // Update work areas
                    state.workAreas.forEach(workArea => {
                        const index = workArea.shiftTemplateIds.indexOf(currentShiftTemplateEditorId);
                        if (index >= 0) {
                            if (strategy === '1' && targetShiftId) {
                                // Replace with target shift
                                workArea.shiftTemplateIds[index] = targetShiftId;
                                if (workArea.defaultShiftTemplateId === currentShiftTemplateEditorId) {
                                    workArea.defaultShiftTemplateId = targetShiftId;
                                }
                            } else {
                                // Remove this shift
                                workArea.shiftTemplateIds.splice(index, 1);
                                if (workArea.defaultShiftTemplateId === currentShiftTemplateEditorId) {
                                    workArea.defaultShiftTemplateId = workArea.shiftTemplateIds[0] || null;
                                }
                            }
                        }
                    });
                    
                    // Update jobs
                    state.jobs.forEach(job => {
                        if (job.shiftTemplateId === currentShiftTemplateEditorId) {
                            if (strategy === '1' && targetShiftId) {
                                job.shiftTemplateId = targetShiftId;
                            } else {
                                job.shiftTemplateId = null;
                            }
                        }
                    });
                    
                    // Remove shift template
                    state.shiftTemplates = state.shiftTemplates.filter(st => st.id !== currentShiftTemplateEditorId);
                });
                
                showToast('Schichtvorlage gelöscht', 'success');
                closeShiftTemplateEditor();
            }
            
            function validateShiftTemplateForm() {
                // Clear previous errors
                document.querySelectorAll('.validation-error').forEach(el => {
                    el.classList.remove('show');
                });
                
                if (!document.getElementById('shiftTemplateName').value) {
                    document.getElementById('shiftTemplateNameError').classList.add('show');
                    return false;
                }
                
                const startTime = document.getElementById('shiftTemplateStart').value;
                const endTime = document.getElementById('shiftTemplateEnd').value;
                
                if (!startTime || !endTime) {
                    document.getElementById('shiftTemplateTimeError').textContent = 'Start- und Endzeit sind erforderlich';
                    document.getElementById('shiftTemplateTimeError').classList.add('show');
                    return false;
                }
                
                // Note: We allow endTime < startTime for overnight shifts
                
                return true;
            }
            
            function importProductsCSV() {
                const fileInput = document.getElementById('productCsvFile');
                if (!fileInput.files.length) {
                    showToast('Bitte wählen Sie eine CSV-Datei aus', 'warning');
                    return;
                }
                
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        const lines = content.split('\n').filter(line => line.trim());
                        
                        // Skip header
                        const dataLines = lines.slice(1);
                        const products = [];
                        
                        dataLines.forEach(line => {
                            const parts = line.split(';');
                            if (parts.length >= 5) {
                                const product = {
                                    artikelNr: parts[0].trim(),
                                    bezeichnung: parts[1].trim(),
                                    arbeitsbereichDefault: parts[2].trim() || null,
                                    laufzeitMin: parseInt(parts[3].trim()) || 60,
                                    setupMin: parseInt(parts[4].trim()) || 0,
                                    bemerkung: parts[5] ? parts[5].trim() : ''
                                };
                                products.push(product);
                            }
                        });
                        
                        StateManager.updateState(state => {
                            // Replace all products
                            state.products = products;
                        });
                        
                        showToast(`${products.length} Produkte importiert`, 'success');
                        renderProductsTable();
                        renderProductAutocomplete();
                        
                        // Clear file input
                        fileInput.value = '';
                    } catch (error) {
                        showToast('Fehler beim Parsen der CSV-Datei', 'error');
                        console.error(error);
                    }
                };
                
                reader.onerror = function() {
                    showToast('Fehler beim Lesen der Datei', 'error');
                };
                
                reader.readAsText(file, 'UTF-8');
            }
            
            function importBacklogCSV() {
                const fileInput = document.getElementById('backlogCsvFile');
                if (!fileInput.files.length) {
                    showToast('Bitte wählen Sie eine CSV-Datei aus', 'warning');
                    return;
                }
                
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        const lines = content.split('\n').filter(line => line.trim());
                        
                        // Skip header
                        const dataLines = lines.slice(1);
                        const jobs = [];
                        
                        dataLines.forEach(line => {
                            const parts = line.split(';');
                            if (parts.length >= 5) {
                                const now = new Date();
                                const job = {
                                    id: 'job_imp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                                    artikelNr: parts[0].trim(),
                                    bezeichnung: parts[1] ? parts[1].trim() : '',
                                    batchOderMenge: parseInt(parts[3].trim()) || 1,
                                    priorität: parseInt(parts[4].trim()) || 5,
                                    workAreaId: null,
                                    shiftTemplateId: null,
                                    start: parts[5] ? new Date(parts[5].trim()).toISOString() : new Date().toISOString(),
                                    end: parts[5] ? new Date(new Date(parts[5].trim()).getTime() + 7200000).toISOString() : new Date(Date.now() + 7200000).toISOString(),
                                    status: 'geplant',
                                    notiz: 'CSV Import',
                                    colorTag: '#3b82f6',
                                    createdAt: new Date().toISOString(),
                                    updatedAt: new Date().toISOString()
                                };
                                
                                // Get product info if available
                                const state = StateManager.getState();
                                const product = state.products.find(p => p.artikelNr === job.artikelNr);
                                if (product) {
                                    job.bezeichnung = product.bezeichnung;
                                }
                                
                                jobs.push(job);
                            }
                        });
                        
                        StateManager.updateState(state => {
                            // Add to existing jobs
                            state.jobs.push(...jobs);
                        });
                        
                        showToast(`${jobs.length} Aufträge importiert`, 'success');
                        renderBacklog();
                        
                        // Clear file input
                        fileInput.value = '';
                    } catch (error) {
                        showToast('Fehler beim Parsen der CSV-Datei', 'error');
                        console.error(error);
                    }
                };
                
                reader.onerror = function() {
                    showToast('Fehler beim Lesen der Datei', 'error');
                };
                
                reader.readAsText(file, 'UTF-8');
            }
            
            function importJson() {
                const fileInput = document.getElementById('importJsonFile');
                const strategy = document.getElementById('importStrategy').value;
                
                if (!fileInput.files.length) {
                    showToast('Bitte wählen Sie eine JSON-Datei aus', 'warning');
                    return;
                }
                
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        StorageManager.importData(e.target.result, strategy);
                        showToast('Daten erfolgreich importiert', 'success');
                        
                        // Reload the app
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } catch (error) {
                        showToast('Fehler beim Import: ' + error.message, 'error');
                    }
                };
                
                reader.onerror = function() {
                    showToast('Fehler beim Lesen der Datei', 'error');
                };
                
                reader.readAsText(file, 'UTF-8');
            }
            
            function resetPlanningData() {
                const pin = document.getElementById('adminPin').value;
                const state = StateManager.getState();
                
                if (pin !== state.settings.adminPin) {
                    showToast('Falscher Admin-PIN', 'error');
                    return;
                }
                
                if (!confirm('ACHTUNG: Alle Feinplanungsdaten (Aufträge) werden zurückgesetzt!\nStammdaten bleiben erhalten.\n\nWirklich fortfahren?')) {
                    return;
                }
                
                if (!confirm('Letzte Bestätigung: Diese Aktion kann nicht rückgängig gemacht werden.\nFeinplanungsdaten wirklich zurücksetzen?')) {
                    return;
                }
                
                StorageManager.resetPlanningData();
                showToast('Feinplanungsdaten zurückgesetzt', 'success');
                
                // Reload the app
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
            
            function setupDragAndDrop() {
                let draggedElement = null;
                let dragStartX = 0;
                let dragStartY = 0;
                
                // Drag start for backlog items and job cards
                document.addEventListener('dragstart', function(e) {
                    if (!isAdmin()) {
                        e.preventDefault();
                        return;
                    }
                    
                    if (e.target.classList.contains('backlog-item') || e.target.classList.contains('job-card')) {
                        draggedElement = e.target;
                        draggedElement.classList.add('dragging');
                        dragStartX = e.clientX;
                        dragStartY = e.clientY;
                        
                        // Set drag image
                        e.dataTransfer.setData('text/plain', e.target.dataset.jobId);
                        e.dataTransfer.effectAllowed = 'move';
                    }
                });
                
                // Drag end
                document.addEventListener('dragend', function(e) {
                    if (draggedElement) {
                        draggedElement.classList.remove('dragging');
                        draggedElement = null;
                    }
                    
                    // Remove drop target styles
                    document.querySelectorAll('.drop-target').forEach(el => {
                        el.classList.remove('drop-target');
                    });
                });
                
                // Drag over
                document.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    
                    if (!draggedElement) return;
                    
                    // Find drop target
                    const dropTarget = findDropTarget(e.clientX, e.clientY);
                    
                    // Remove previous drop target styles
                    document.querySelectorAll('.drop-target').forEach(el => {
                        el.classList.remove('drop-target');
                    });
                    
                    // Add style to current drop target
                    if (dropTarget) {
                        dropTarget.classList.add('drop-target');
                    }
                });
                
                // Drop
                document.addEventListener('drop', function(e) {
                    e.preventDefault();
                    
                    if (!draggedElement || !isAdmin()) return;
                    
                    const jobId = draggedElement.dataset.jobId;
                    if (!jobId) return;
                    
                    const dropTarget = findDropTarget(e.clientX, e.clientY);
                    if (!dropTarget) return;
                    
                    const state = StateManager.getState();
                    const job = state.jobs.find(j => j.id === jobId);
                    if (!job) return;
                    
                    // Determine drop location
                    const daySlot = dropTarget.closest('.day-slot');
                    const workAreaItem = dropTarget.closest('.workarea-item');
                    
                    if (daySlot) {
                        // Drop on planning board
                        const workAreaId = daySlot.dataset.workAreaId;
                        const dayIndex = parseInt(daySlot.dataset.dayIndex);
                        
                        // Calculate date
                        const currentDate = new Date(state.settings.currentDate);
                        const startOfWeek = new Date(currentDate);
                        const day = startOfWeek.getDay();
                        const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1);
                        startOfWeek.setDate(diff);
                        
                        const targetDate = new Date(startOfWeek);
                        targetDate.setDate(startOfWeek.getDate() + dayIndex);
                        
                        // Calculate time based on drop position
                        const rect = daySlot.getBoundingClientRect();
                        const relativeY = e.clientY - rect.top;
                        const percentage = relativeY / rect.height;
                        const hours = 6 + (percentage * 16); // 6:00 to 22:00
                        
                        const hoursInt = Math.floor(hours);
                        const minutes = Math.floor((hours - hoursInt) * 60);
                        const snappedMinutes = Math.round(minutes / 15) * 15;
                        
                        const newStart = new Date(targetDate);
                        newStart.setHours(hoursInt, snappedMinutes, 0, 0);
                        
                        // Get work area to determine default shift
                        const workArea = StateManager.getWorkArea(workAreaId);
                        let shiftTemplateId = null;
                        
                        if (workArea && workArea.defaultShiftTemplateId) {
                            shiftTemplateId = workArea.defaultShiftTemplateId;
                        }
                        
                        // Calculate end time (preserve duration)
                        const oldStart = new Date(job.start);
                        const oldEnd = new Date(job.end);
                        const duration = oldEnd - oldStart;
                        
                        const newEnd = new Date(newStart.getTime() + duration);
                        
                        // Update job
                        StateManager.updateState(state => {
                            const jobIndex = state.jobs.findIndex(j => j.id === jobId);
                            if (jobIndex >= 0) {
                                state.jobs[jobIndex].workAreaId = workAreaId;
                                state.jobs[jobIndex].shiftTemplateId = shiftTemplateId;
                                state.jobs[jobIndex].start = newStart.toISOString();
                                state.jobs[jobIndex].end = newEnd.toISOString();
                                state.jobs[jobIndex].updatedAt = new Date().toISOString();
                            }
                        });
                        
                        showToast('Auftrag im Plan platziert', 'success');
                        
                    } else if (workAreaItem && draggedElement.classList.contains('job-card')) {
                        // Drag job card to work area list (move to backlog)
                        StateManager.updateState(state => {
                            const jobIndex = state.jobs.findIndex(j => j.id === jobId);
                            if (jobIndex >= 0) {
                                state.jobs[jobIndex].workAreaId = null;
                                state.jobs[jobIndex].shiftTemplateId = null;
                                state.jobs[jobIndex].updatedAt = new Date().toISOString();
                            }
                        });
                        
                        showToast('Auftrag in Backlog verschoben', 'success');
                    }
                    
                    // Remove drop target styles
                    document.querySelectorAll('.drop-target').forEach(el => {
                        el.classList.remove('drop-target');
                    });
                });
                
                function findDropTarget(x, y) {
                    const elements = document.elementsFromPoint(x, y);
                    
                    for (let el of elements) {
                        if (el.classList.contains('day-slot') || 
                            el.classList.contains('workarea-item') ||
                            el.classList.contains('backlog-item')) {
                            return el;
                        }
                    }
                    
                    return null;
                }
            }
            
            function showToast(message, type = 'info') {
                const container = document.getElementById('toastContainer');
                
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                
                const icon = document.createElement('i');
                icon.className = 'toast-icon';
                
                switch(type) {
                    case 'success': icon.className += ' fas fa-check-circle'; break;
                    case 'error': icon.className += ' fas fa-exclamation-circle'; break;
                    case 'warning': icon.className += ' fas fa-exclamation-triangle'; break;
                    default: icon.className += ' fas fa-info-circle'; break;
                }
                
                const text = document.createElement('div');
                text.textContent = message;
                
                toast.appendChild(icon);
                toast.appendChild(text);
                container.appendChild(toast);
                
                // Show toast
                setTimeout(() => {
                    toast.classList.add('show');
                }, 10);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (container.contains(toast)) {
                            container.removeChild(toast);
                        }
                    }, 300);
                }, 5000);
            }
            
            function isAdmin() {
                const state = StateManager.getState();
                return state.settings.currentRole === 'ADMIN';
            }
            
            // Utility functions
            function formatDate(date) {
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                return date.toLocaleDateString('de-DE', options);
            }
            
            function formatDay(dayIndex) {
                const days = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
                return days[dayIndex];
            }
            
            function formatTime(date) {
                return date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            }
            
            function formatDateTime(date) {
                return date.toLocaleString('de-DE', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            
            function formatDateTimeLocal(date) {
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            }
            
            function adjustAlpha(color, alpha) {
                if (color.startsWith('#')) {
                    const r = parseInt(color.slice(1, 3), 16);
                    const g = parseInt(color.slice(3, 5), 16);
                    const b = parseInt(color.slice(5, 7), 16);
                    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
                }
                return color;
            }
            
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
            
            return {
                init
            };
        })();

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            UIManager.init();
        });
    </script>
</body>
</html>
                    <div class="validation-error" id="workAreaShiftsError">Mindestens eine Schichtvorlage muss ausgewählt werden</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Standard-Schicht</label>
                    <select class="form-control" id="workAreaDefaultShift">
                        <option value="">-- Keine Standard-Schicht --</option>
                        <!-- Dynamically populated -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Farbe</label>
                    <div class="color-picker" id="workAreaColorPicker">
                        <div class="color-option" style="background: #3b82f6;" data-color="#3b82f6"></div>
                        <div class="color-option" style="background: #10b981;" data-color="#10b981"></div>
                        <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b"></div>
                        <div class="color-option" style="background: #ef4444;" data-color="#ef4444"></div>
                        <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6"></div>
                        <div class="color-option" style="background: #ec4899;" data-color="#ec4899"></div>
                        <div class="color-option selected" style="background: #6366f1;" data-color="#6366f1"></div>
                    </div>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="workAreaActive" checked>
                    <label class="form-check-label">Aktiv</label>
                </div>
                <div class="form-group" id="workAreaImpactPreview" style="display: none;">
                    <div style="background: #f3f4f6; border-radius: var(--border-radius); padding: 1rem;">
                        <h5>Auswirkungsvorschau</h5>
                        <p id="workAreaImpactText">0 Jobs betroffen</p>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn" id="cancelWorkAreaBtn">Abbrechen</button>
            <button class="btn btn-danger" id="deleteWorkAreaBtn" style="display: none;">Löschen</button>
            <button class="btn btn-primary" id="saveWorkAreaBtn">Speichern</button>
        </div>
    </div>

    <!-- Shift Template Editor Drawer -->
    <div class="drawer" id="shiftTemplateDrawer">
        <div class="modal-header">
            <div class="modal-title" id="shiftTemplateDrawerTitle">Neue Schichtvorlage</div>
            <button class="modal-close" id="closeShiftTemplateDrawer">&times;</button>
        </div>
        <div class="modal-body">
            <form id="shiftTemplateForm">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" class="form-control" id="shiftTemplateName" required>
                    <div class="validation-error" id="shiftTemplateNameError">Name ist erforderlich</div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Startzeit *</label>
                        <input type="time" class="form-control" id="shiftTemplateStart" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Endzeit *</label>
                        <input type="time" class="form-control" id="shiftTemplateEnd" required>
                        <div class="validation-error" id="shiftTemplateTimeError">Endzeit muss nach Startzeit liegen (über Mitternacht möglich)</div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Pause (Minuten)</label>
                    <input type="number" class="form-control" id="shiftTemplateBreak" min="0" step="1" value="30">
                </div>
                <div class="form-group">
                    <label class="form-label">Farbe</label>
                    <div class="color-picker" id="shiftTemplateColorPicker">
                        <div class="color-option" style="background: #3b82f6;" data-color="#3b82f6"></div>
                        <div class="color-option" style="background: #10b981;" data-color="#10b981"></div>
                        <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b"></div>
                        <div class="color-option" style="background: #ef4444;" data-color="#ef4444"></div>
                        <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6"></div>
                        <div class="color-option" style="background: #ec4899;" data-color="#ec4899"></div>
                        <div class="color-option selected" style="background: #6366f1;" data-color="#6366f1"></div>
                    </div>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="shiftTemplateActive" checked>
                    <label class="form-check-label">Aktiv</label>
                </div>
                <div class="form-group" id="shiftTemplateImpactPreview" style="display: none;">
                    <div style="background: #f3f4f6; border-radius: var(--border-radius); padding: 1rem;">
                        <h5>Auswirkungsvorschau</h5>
                        <p id="shiftTemplateImpactText">0 Arbeitsbereiche und 0 Jobs betroffen</p>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn" id="cancelShiftTemplateBtn">Abbrechen</button>
            <button class="btn btn-danger" id="deleteShiftTemplateBtn" style="display: none;">Löschen</button>
            <button class="btn btn-primary" id="saveShiftTemplateBtn">Speichern</button>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- JavaScript -->
</body>
</html>